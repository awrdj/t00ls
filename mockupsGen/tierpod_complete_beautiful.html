<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TierPOD Pro - Professional Mockup Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --secondary-dark: #7c3aed;
            --accent: #ec4899;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --border: #e5e7eb;
            --border-light: #f3f4f6;
            --dark: #1f2937;
            --gray: #6b7280;
            --light-bg: #fafafa;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 6px 12px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            color: var(--dark);
            overflow: hidden;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--border-light);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
            border: 2px solid var(--border-light);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary-dark));
        }

        .app-container {
            display: flex;
            height: 100vh;
            padding: 20px;
            gap: 20px;
        }

        .sidebar {
            width: 340px;
            background: white;
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .sidebar-header {
            padding: 32px 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            position: relative;
            overflow: hidden;
        }

        .sidebar-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .sidebar-header h1 {
            font-size: 1.8em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            z-index: 1;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .sidebar-header h1 i {
            font-size: 0.9em;
            animation: sparkle 2s ease-in-out infinite;
        }

        @keyframes sparkle {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(-10deg) scale(1.1); }
            75% { transform: rotate(10deg) scale(1.1); }
        }

        .sidebar-header p {
            font-size: 0.95em;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }

        .nav-menu {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-header {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            font-size: 0.9em;
            color: var(--dark);
            background: white;
        }

        .nav-section-header:hover {
            background: var(--border-light);
            transform: translateX(4px);
        }

        .toggle-icon {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--primary);
        }

        .nav-section-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .nav-section-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nav-section-content.collapsed {
            max-height: 0;
        }

        .folder-list {
            list-style: none;
            padding: 8px 0;
        }

        .folder-item {
            padding: 12px 16px;
            margin: 6px 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            background: white;
        }

        .folder-item:hover {
            background: var(--border-light);
            transform: translateX(4px);
        }

        .folder-item.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: var(--shadow-md);
            transform: translateX(4px);
        }

        .folder-icon {
            font-size: 1.2em;
            width: 24px;
            text-align: center;
            transition: transform 0.3s;
        }

        .folder-item:hover .folder-icon {
            transform: scale(1.1);
        }

        .folder-name {
            flex: 1;
            font-size: 0.9em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-weight: 500;
        }

        .folder-count {
            background: rgba(99, 102, 241, 0.15);
            color: var(--primary);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 700;
            transition: all 0.3s;
        }

        .folder-item.active .folder-count {
            background: rgba(255, 255, 255, 0.25);
            color: white;
        }

        .folder-delete-btn {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 6px;
            border-radius: 8px;
            opacity: 0;
            transition: all 0.3s;
        }

        .folder-item:hover .folder-delete-btn {
            opacity: 0.6;
        }

        .folder-delete-btn:hover {
            opacity: 1 !important;
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            transform: scale(1.1);
        }

        .add-folder-btn {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin: 12px 0;
            box-shadow: var(--shadow);
        }

        .add-folder-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            background: linear-gradient(to bottom, transparent, rgba(99, 102, 241, 0.03));
        }

        .stats-box {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .stat-item {
            background: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all 0.3s;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }

        .stat-value {
            font-size: 1.6em;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.75em;
            color: var(--gray);
            margin-top: 4px;
            font-weight: 500;
        }

        .storage-meter {
            background: var(--border-light);
            border-radius: 12px;
            padding: 12px;
            margin-top: 12px;
        }

        .storage-meter-label {
            font-size: 0.75em;
            color: var(--gray);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            font-weight: 500;
        }

        .storage-bar {
            height: 8px;
            background: white;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .storage-fill {
            height: 100%;
            background: linear-gradient(to right, var(--success), var(--info));
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 4px;
        }

        .storage-fill.warning {
            background: linear-gradient(to right, var(--warning), var(--danger));
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            gap: 20px;
        }

        .top-bar {
            background: white;
            border-radius: 24px;
            padding: 20px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .top-bar h2 {
            font-size: 1.6em;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .folder-badge {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 0.5em;
            font-weight: 600;
            margin-left: 12px;
            box-shadow: var(--shadow);
        }

        .top-bar-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn i, .btn span {
            position: relative;
            z-index: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: white;
            border: 2px solid var(--border);
            color: var(--dark);
        }

        .btn-secondary:hover:not(:disabled) {
            border-color: var(--primary);
            background: var(--border-light);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info), #2563eb);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .generator-wrapper {
            flex: 1;
            overflow: hidden;
        }

        .generator-grid {
            display: grid;
            grid-template-columns: 340px 1fr 300px;
            gap: 20px;
            height: 100%;
        }

        .panel {
            background: white;
            border-radius: 24px;
            padding: 24px;
            box-shadow: var(--shadow-xl);
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(10px);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-light);
        }

        .panel-title {
            font-size: 1.2em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--dark);
        }

        .panel-title i {
            color: var(--primary);
        }

        .upload-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .upload-btn {
            padding: 16px;
            border: 2px dashed var(--border);
            border-radius: 16px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        .upload-btn:hover {
            border-color: var(--primary);
            border-style: solid;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .upload-btn i {
            display: block;
            font-size: 2em;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .mockup-list {
            list-style: none;
        }

        .mockup-item {
            padding: 14px;
            margin: 10px 0;
            border: 2px solid var(--border);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }

        .mockup-item:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }

        .mockup-item.selected {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border-color: var(--primary);
            font-weight: 600;
            box-shadow: var(--shadow-md);
        }

        .mockup-name {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            overflow: hidden;
        }

        .mockup-name i {
            color: var(--primary);
            font-size: 1em;
        }

        .mockup-name span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.9em;
        }

        .mockup-badge {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: var(--shadow);
        }

        .library-badge {
            background: linear-gradient(135deg, var(--info), #2563eb);
            color: white;
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 0.65em;
            font-weight: 700;
        }

        .mockup-toggle {
            position: relative;
            width: 40px;
            height: 22px;
            background: #d1d5db;
            border-radius: 11px;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .mockup-toggle.enabled {
            background: linear-gradient(135deg, var(--success), #059669);
        }

        .mockup-toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .mockup-toggle.enabled .mockup-toggle-slider {
            transform: translateX(18px);
        }

        .mockup-item.disabled {
            opacity: 0.5;
        }

        .mockup-folder-btn, .delete-mockup-btn {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .mockup-folder-btn:hover {
            background: var(--border-light);
            color: var(--primary);
        }

        .delete-mockup-btn {
            color: var(--danger);
        }

        .delete-mockup-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            transform: scale(1.1);
        }

        .preview-wrapper {
            position: relative;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.08));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            padding: 24px;
            border: 2px dashed var(--border);
            flex: 1;
        }

        .preview-container {
            position: relative;
            max-width: 100%;
            max-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* TASK 2: Watermark preview overlay */
        .watermark-preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            opacity: 0.5;
            display: none;
        }

        .watermark-preview-overlay.active {
            display: block;
        }

        .watermark-preview-overlay canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #mockupPreview {
            max-width: 100%;
            max-height: 100%;
            display: none;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            border-radius: 16px;
        }

        #mockupPreview.visible {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .preview-placeholder {
            text-align: center;
            color: var(--gray);
        }

        .preview-placeholder i {
            font-size: 5em;
            margin-bottom: 20px;
            opacity: 0.3;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .design-wrapper {
            position: absolute;
            border: 3px dashed var(--primary);
            cursor: move;
            background: rgba(99, 102, 241, 0.08);
            min-width: 50px;
            min-height: 50px;
            transition: all 0.2s;
        }

        .design-wrapper.active {
            border-color: var(--success);
            border-style: solid;
            background: rgba(16, 185, 129, 0.08);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
        }

        .design-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--primary);
            text-align: center;
            padding: 8px;
            font-weight: 600;
        }

        .resize-handle {
            position: absolute;
            right: -10px;
            bottom: -10px;
            width: 24px;
            height: 24px;
            background: white;
            border: 3px solid var(--primary);
            cursor: nwse-resize;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
            transition: all 0.2s;
        }

        .resize-handle:hover {
            transform: scale(1.2);
        }

        .rotate-handle {
            position: absolute;
            top: -38px;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--success), #059669);
            border-radius: 50%;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10;
            transition: all 0.2s;
        }

        .rotate-handle:hover {
            transform: translateX(-50%) scale(1.15);
        }

        .remove-handle {
            position: absolute;
            top: -16px;
            right: -16px;
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 10;
            transition: all 0.2s;
        }

        .remove-handle:hover {
            transform: scale(1.15) rotate(90deg);
        }

        .element-label {
            position: absolute;
            top: -34px;
            left: 0;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            white-space: nowrap;
        }

        .controls-section {
            margin-bottom: 24px;
        }

        .controls-title {
            font-size: 0.95em;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--dark);
        }

        .controls-title i {
            color: var(--primary);
        }

        .aspect-ratio-group {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .aspect-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            transition: all 0.3s;
        }

        .aspect-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .aspect-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-color: transparent;
            box-shadow: var(--shadow-md);
        }

        .custom-ratio-input {
            display: none;
            gap: 8px;
            margin-top: 8px;
        }

        .custom-ratio-input.active {
            display: flex;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--border-light);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
        }

        input[type="text"], input[type="number"] {
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .watermark-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 12px;
        }

        .watermark-option {
            aspect-ratio: 1;
            border: 3px solid var(--border);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--border-light);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .watermark-option:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .watermark-option.selected {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
            transform: translateY(-4px);
        }

        .watermark-option img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .watermark-option.none {
            font-weight: 600;
            color: var(--gray);
            flex-direction: column;
            gap: 6px;
        }

        .watermark-option.none i {
            font-size: 1.8em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.75);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 36px;
            max-width: 900px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-light);
        }

        .modal-header h3 {
            font-size: 1.6em;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .close-modal {
            background: var(--border-light);
            border: none;
            font-size: 1.8em;
            cursor: pointer;
            color: var(--gray);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-modal:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        .library-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .category-btn {
            padding: 20px;
            border: 2px solid var(--border);
            border-radius: 16px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
        }

        .category-btn:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .category-btn.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            box-shadow: var(--shadow-md);
        }

        .category-btn i {
            display: block;
            font-size: 2.2em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .library-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            justify-content: space-between;
            align-items: center;
        }

        .library-selection-info {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            color: var(--primary);
            font-weight: 700;
            font-size: 0.9em;
            padding: 8px 16px;
            border-radius: 12px;
        }

        .library-mockups {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
        }

        .library-mockup-item {
            border: 2px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            position: relative;
        }

        .library-mockup-item:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .library-mockup-item.selected {
            border-color: var(--success);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
        }

        .library-mockup-checkbox {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            border: 2px solid white;
            border-radius: 8px;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.3s;
            backdrop-filter: blur(4px);
        }

        .library-mockup-item.selected .library-mockup-checkbox {
            background: linear-gradient(135deg, var(--success), #059669);
            border-color: var(--success);
            transform: scale(1.1);
        }

        .library-mockup-checkbox i {
            color: white;
            font-size: 0.9em;
            display: none;
        }

        .library-mockup-item.selected .library-mockup-checkbox i {
            display: block;
        }

        .library-mockup-img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            background: var(--border-light);
        }

        .library-mockup-name {
            padding: 12px;
            font-size: 0.85em;
            font-weight: 600;
            text-align: center;
            border-top: 1px solid var(--border);
            background: white;
        }

        .folder-icon-grid, .folder-color-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 12px;
            margin: 16px 0;
        }

        .folder-icon-option, .folder-color-option {
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 1.4em;
        }

        .folder-icon-option:hover, .folder-color-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .folder-icon-option.selected, .folder-color-option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            transform: translateY(-2px);
        }

        .folder-color-option {
            height: 50px;
            border-radius: 12px;
        }

        .progress-bar {
            height: 50px;
            background: var(--border-light);
            border-radius: 25px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 16px;
        }

        .info-box {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-left: 4px solid var(--warning);
            padding: 16px;
            border-radius: 12px;
            font-size: 0.85em;
            line-height: 1.7;
            margin-top: 20px;
            box-shadow: var(--shadow);
        }

        .info-box strong {
            display: block;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 4em;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .loading-spinner {
            border: 5px solid var(--border-light);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 30px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Folder context menu */
        .folder-context-menu {
            position: absolute;
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            min-width: 220px;
            padding: 8px;
            animation: fadeIn 0.2s;
        }

        .folder-context-menu-item {
            padding: 12px 14px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .folder-context-menu-item:hover {
            background: var(--border-light);
            transform: translateX(4px);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-magic"></i>TierPOD Pro</h1>
                <p>Professional Mockup Generator</p>
            </div>

            <div class="nav-menu">
                <!-- Folders Section -->
                <div class="nav-section">
                    <div class="nav-section-header" id="foldersToggle">
                        <span><i class="fas fa-folder"></i> Folders</span>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="nav-section-content" id="foldersContent">
                        <ul class="folder-list" id="folderList"></ul>
                        <button class="add-folder-btn" id="addFolderBtnInline">
                            <i class="fas fa-plus"></i>
                            <span>New Folder</span>
                        </button>
                    </div>
                </div>

                <!-- Watermarks Section -->
                <div class="nav-section">
                    <div class="nav-section-header" id="watermarksToggle">
                        <span><i class="fas fa-droplet"></i> Watermark</span>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="nav-section-content" id="watermarksContent">
                        <div class="watermark-grid" id="watermarkGrid"></div>
                        <div class="info-box">
                            <strong><i class="fas fa-info-circle"></i> Watermark Info</strong>
                            Selected watermark will cover the entire mockup in a tiled pattern
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="stats-box">
                    <div class="stat-item">
                        <div class="stat-value" id="mockupCount">0</div>
                        <div class="stat-label">Templates</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="storagePercent">0%</div>
                        <div class="stat-label">Storage</div>
                    </div>
                </div>
                <div class="storage-meter">
                    <div class="storage-meter-label">
                        <span>Storage Used</span>
                        <span id="storageSize">0 MB</span>
                    </div>
                    <div class="storage-bar">
                        <div class="storage-fill" id="storageFill"></div>
                    </div>
                </div>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 12px;" onclick="clearStorage()">
                    <i class="fas fa-trash"></i>
                    <span>Clear All Data</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Bar -->
            <div class="top-bar">
                <h2>
                    <i class="fas fa-layer-group"></i>
                    Workspace
                    <span class="folder-badge" id="currentFolderBadge" style="display: none;"></span>
                </h2>
                <div class="top-bar-actions">
                    <button class="btn btn-success" id="loadExportBtn" disabled>
                        <i class="fas fa-rocket"></i>
                        <span>Generate & Download</span>
                    </button>
                </div>
            </div>

            <!-- Generator Area -->
            <div class="generator-wrapper">
                <div class="generator-grid">
                    <!-- Left Panel: Template Management -->
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title">
                                <i class="fas fa-images"></i>
                                Templates
                            </div>
                        </div>

                        <div class="upload-options">
                            <div class="upload-btn" id="uploadDesktopBtn">
                                <i class="fas fa-upload"></i>
                                <div>Upload</div>
                            </div>
                            <div class="upload-btn" id="browseLibraryBtn">
                                <i class="fas fa-book"></i>
                                <div>Library</div>
                            </div>
                        </div>

                        <ul class="mockup-list" id="mockupList">
                            <li class="empty-state">
                                <i class="fas fa-images"></i>
                                <p>No templates yet</p>
                                <small>Upload or browse library</small>
                            </li>
                        </ul>
                    </div>

                    <!-- Center Panel: Preview -->
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title">
                                <i class="fas fa-eye"></i>
                                Preview
                            </div>
                        </div>
                        <div class="preview-wrapper">
                            <div class="preview-container" id="previewContainer">
                                <div class="preview-placeholder">
                                    <i class="fas fa-image"></i>
                                    <p>Select a template to start</p>
                                </div>
                                <img id="mockupPreview" alt="Mockup Preview">
                                <!-- TASK 2: Watermark preview overlay -->
                                <div class="watermark-preview-overlay" id="watermarkPreviewOverlay">
                                    <canvas id="watermarkPreviewCanvas"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel: Controls -->
                    <div class="panel">
                        <div class="panel-header">
                            <div class="panel-title">
                                <i class="fas fa-sliders"></i>
                                Controls
                            </div>
                        </div>

                        <div class="controls-section">
                            <div class="controls-title">
                                <i class="fas fa-crop"></i>
                                Aspect Ratio
                            </div>
                            <div class="aspect-ratio-group">
                                <button class="aspect-btn active" data-ratio="free">Free</button>
                                <button class="aspect-btn" data-ratio="1:1">1:1</button>
                                <button class="aspect-btn" data-ratio="16:9">16:9</button>
                            </div>
                            <div class="aspect-ratio-group">
                                <button class="aspect-btn" data-ratio="4:3">4:3</button>
                                <button class="aspect-btn" data-ratio="3:4">3:4</button>
                                <button class="aspect-btn" data-ratio="custom">Custom</button>
                            </div>
                            <div class="custom-ratio-input" id="customRatioInput">
                                <input type="number" id="ratioWidth" placeholder="W" min="1" value="1">
                                <span style="display: flex; align-items: center;">:</span>
                                <input type="number" id="ratioHeight" placeholder="H" min="1" value="1">
                                <button class="btn btn-primary" onclick="applyCustomRatio()" style="padding: 10px 16px;">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>

                        <div class="controls-section">
                            <div class="controls-title">
                                <i class="fas fa-adjust"></i>
                                Opacity
                            </div>
                            <input type="range" id="opacitySlider" min="0" max="1" step="0.01" value="1" disabled>
                            <div style="text-align: center; margin-top: 8px; font-weight: 600; color: var(--primary);">
                                <span id="opacityValue">100%</span>
                            </div>
                        </div>

                        <div class="controls-section">
                            <button class="btn btn-primary" id="addPngBtn" disabled style="width: 100%; margin-bottom: 12px;">
                                <i class="fas fa-plus"></i>
                                <span>Add Design Area</span>
                            </button>
                            <button class="btn btn-success" id="savePositionBtn" disabled style="width: 100%;">
                                <i class="fas fa-save"></i>
                                <span>Save Position</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden File Inputs -->
    <input type="file" id="mockupFilesInput" accept="image/*" multiple style="display: none;">
    <input type="file" id="designPngsInput" accept="image/png,image/jpg,image/jpeg" multiple style="display: none;">

    <!-- Library Modal -->
    <div class="modal" id="libraryModal">
        <div class="modal-content" style="max-width: 1100px;">
            <div class="modal-header">
                <h3><i class="fas fa-book"></i> Mockup Library</h3>
                <button class="close-modal" id="closeLibraryModal">&times;</button>
            </div>
            <div class="library-categories" id="libraryCategories"></div>
            <div class="library-actions">
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" id="selectAllBtn">
                        <i class="fas fa-check-double"></i>
                        <span>Select All</span>
                    </button>
                    <button class="btn btn-secondary" id="deselectAllBtn">
                        <i class="fas fa-times"></i>
                        <span>Deselect All</span>
                    </button>
                </div>
                <div class="library-selection-info" id="librarySelectionInfo">0 selected</div>
            </div>
            <div id="libraryLoadingState" style="display: none;">
                <div class="loading-spinner"></div>
                <p style="text-align: center; color: var(--gray);">Loading mockups...</p>
            </div>
            <div class="library-mockups" id="libraryMockups"></div>
            <button class="btn btn-primary" id="addSelectedMockupsBtn" disabled style="width: 100%; margin-top: 24px; padding: 16px;">
                <i class="fas fa-plus"></i>
                <span>Add Selected Mockups to Workspace</span>
            </button>
        </div>
    </div>

    <!-- Folder Creation Modal -->
    <div class="modal" id="folderModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-folder-plus"></i> Create Folder</h3>
                <button class="close-modal" id="cancelFolderBtn">&times;</button>
            </div>
            <div>
                <label style="display: block; margin-bottom: 8px; font-weight: 600;">Folder Name</label>
                <input type="text" id="folderNameInput" placeholder="My Folder" style="width: 100%; padding: 12px; font-size: 1em;">

                <label style="display: block; margin: 20px 0 12px; font-weight: 600;">Icon</label>
                <div class="folder-icon-grid">
                    <div class="folder-icon-option selected" data-icon="fa-folder"><i class="fas fa-folder"></i></div>
                    <div class="folder-icon-option" data-icon="fa-heart"><i class="fas fa-heart"></i></div>
                    <div class="folder-icon-option" data-icon="fa-star"><i class="fas fa-star"></i></div>
                    <div class="folder-icon-option" data-icon="fa-fire"><i class="fas fa-fire"></i></div>
                    <div class="folder-icon-option" data-icon="fa-bolt"><i class="fas fa-bolt"></i></div>
                    <div class="folder-icon-option" data-icon="fa-crown"><i class="fas fa-crown"></i></div>
                </div>

                <label style="display: block; margin: 20px 0 12px; font-weight: 600;">Color</label>
                <div class="folder-color-grid">
                    <div class="folder-color-option selected" data-color="#667eea" style="background: #667eea;"></div>
                    <div class="folder-color-option" data-color="#f093fb" style="background: #f093fb;"></div>
                    <div class="folder-color-option" data-color="#4facfe" style="background: #4facfe;"></div>
                    <div class="folder-color-option" data-color="#43e97b" style="background: #43e97b;"></div>
                    <div class="folder-color-option" data-color="#fa709a" style="background: #fa709a;"></div>
                    <div class="folder-color-option" data-color="#feca57" style="background: #feca57;"></div>
                </div>

                <button class="btn btn-primary" id="createFolderBtn" style="width: 100%; margin-top: 24px; padding: 14px;">
                    <i class="fas fa-check"></i>
                    <span>Create Folder</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Progress Modal -->
    <div class="modal" id="progressModal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 style="margin-bottom: 24px; text-align: center;"><i class="fas fa-spinner fa-spin"></i> Processing...</h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
            </div>
            <p id="progressText" style="text-align: center; color: var(--gray);">Preparing...</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // Configuration
        const LIBRARY_CONFIG = {
            baseUrl: 'https://raw.githubusercontent.com/awrdj/t00ls/main/mockupsGen/mckps',
            categories: {
                kids_mockups: {
                    name: 'Kids',
                    icon: 'fa-child',
                    mockups: ['Kids1.jpg', 'Kids2.jpg'],
                    thumbnailFolder: 'kids_thumbnails'
                },
                family_mockups: {
                    name: 'Family',
                    icon: 'fa-people-group',
                    mockups: ['Family1.jpg', 'Family2.jpg', 'Family3.jpg'],
                    thumbnailFolder: 'family_thumbnails'
                },
                flat_mockups: {
                    name: 'Flat Lay',
                    icon: 'fa-layer-group',
                    mockups: ['Flat1.jpg', 'Flat2.jpg'],
                    thumbnailFolder: 'flat_thumbnails'
                },
                men_mockups: {
                    name: 'Men',
                    icon: 'fa-person',
                    mockups: ['Men1.jpg', 'Men2.jpg'],
                    thumbnailFolder: 'men_thumbnails'
                },
                women_mockups: {
                    name: 'Women',
                    icon: 'fa-person-dress',
                    mockups: ['Women1.jpg', 'Women2.jpg'],
                    thumbnailFolder: 'women_thumbnails'
                }
            },
            watermarks: {
                baseUrl: 'https://raw.githubusercontent.com/awrdj/t00ls/main/mockupsGen/mckps/wtrmrks',
                files: ['Watermark1.png', 'Watermark2.png', 'Watermark3.png']
            }
        };

        // Database
        const DB_NAME = 'TierPodDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'mockups';
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        objectStore.createIndex('name', 'name', { unique: false });
                    }
                };
            });
        }

        function saveMockupToDB(mockup) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.put(mockup);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getAllMockupsFromDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteMockupFromDB(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function clearAllDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.clear();
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function getDBSize() {
            try {
                const mockups = await getAllMockupsFromDB();
                let totalSize = 0;
                for (const mockup of mockups) {
                    if (mockup.dataUrl) {
                        const base64Data = mockup.dataUrl.split(',')[1] || mockup.dataUrl;
                        totalSize += base64Data.length * 0.75;
                    }
                }
                return totalSize;
            } catch (error) {
                console.error('Storage calculation error:', error);
                return 0;
            }
        }

        // State
        const state = {
            mockups: [],
            currentMockup: null,
            designElements: [],
            activeElement: null,
            savedMockupData: {},
            currentAspectRatio: 'free',
            mockupEnabled: {},
            folders: [],
            currentFolderId: 'all',
            mockupToFolder: {},
            selectedWatermark: null,
            watermarkImages: {},
            selectedLibraryMockups: new Set(),
            currentLibraryCategory: null
        };

        let elementIdCounter = 0;

        // Watermark System
        async function loadWatermarks() {
            const grid = document.getElementById('watermarkGrid');
            grid.innerHTML = '';

            const noneOption = document.createElement('div');
            noneOption.className = 'watermark-option none selected';
            noneOption.dataset.watermarkId = 'none';
            noneOption.innerHTML = '<i class="fas fa-ban"></i><div style="font-size: 0.7em; margin-top: 4px;">None</div>';
            grid.appendChild(noneOption);

            for (let i = 0; i < LIBRARY_CONFIG.watermarks.files.length; i++) {
                const filename = LIBRARY_CONFIG.watermarks.files[i];
                const url = `${LIBRARY_CONFIG.watermarks.baseUrl}/${filename}`;

                const option = document.createElement('div');
                option.className = 'watermark-option';
                option.dataset.watermarkId = url;

                const img = document.createElement('img');
                img.src = url;
                img.alt = `Watermark ${i + 1}`;
                img.onerror = () => {
                    option.innerHTML = '<i class="fas fa-image-slash" style="font-size: 1.5em; color: var(--gray);"></i>';
                };

                option.appendChild(img);
                grid.appendChild(option);

                try {
                    const watermarkImg = await loadImage(url);
                    state.watermarkImages[url] = watermarkImg;
                    console.log(' Watermark loaded:', filename);
                } catch (e) {
                    console.warn(' Failed to load watermark:', url);
                }
            }

            document.querySelectorAll('.watermark-option').forEach(option => {
                option.addEventListener('click', function() {
                    const watermarkId = this.dataset.watermarkId;
                    selectWatermark(watermarkId === 'none' ? null : watermarkId);
                });
            });

            console.log(' Watermark system initialized');
        }

        function selectWatermark(url) {
            state.selectedWatermark = url;

            document.querySelectorAll('.watermark-option').forEach(el => {
                el.classList.remove('selected');
            });

            if (url === null) {
                document.querySelector('.watermark-option.none')?.classList.add('selected');
                console.log(' Watermark: None selected');
            } else {
                document.querySelector(`.watermark-option[data-watermark-id="${url}"]`)?.classList.add('selected');
                console.log(' Watermark selected:', url);
            }

            // TASK 2: Update preview
            updateWatermarkPreview();
        }

        // TASK 2: Tiled watermark drawing
        function drawTiledWatermark(ctx, watermarkImg, canvasWidth, canvasHeight, opacity = 0.8) {
            if (!watermarkImg) return;

            ctx.save();
            ctx.globalAlpha = opacity;

            const wmWidth = watermarkImg.width;
            const wmHeight = watermarkImg.height;

            const cols = Math.ceil(canvasWidth / wmWidth) + 1;
            const rows = Math.ceil(canvasHeight / wmHeight) + 1;

            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const x = col * wmWidth;
                    const y = row * wmHeight;
                    ctx.drawImage(watermarkImg, x, y, wmWidth, wmHeight);
                }
            }

            ctx.restore();
        }

        // TASK 2: Update watermark preview
        function updateWatermarkPreview() {
            const overlay = document.getElementById('watermarkPreviewOverlay');
            const canvas = document.getElementById('watermarkPreviewCanvas');
            const mockupPreview = document.getElementById('mockupPreview');

            if (!state.selectedWatermark || !state.watermarkImages[state.selectedWatermark]) {
                overlay.classList.remove('active');
                return;
            }

            if (!state.currentMockup) {
                overlay.classList.remove('active');
                return;
            }

            const mockupRect = mockupPreview.getBoundingClientRect();

            canvas.width = mockupRect.width * 2;
            canvas.height = mockupRect.height * 2;
            canvas.style.width = mockupRect.width + 'px';
            canvas.style.height = mockupRect.height + 'px';

            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const watermarkImg = state.watermarkImages[state.selectedWatermark];

            const scaleX = canvas.width / state.currentMockup.originalWidth;
            const scaleY = canvas.height / state.currentMockup.originalHeight;

            ctx.scale(scaleX, scaleY);
            drawTiledWatermark(ctx, watermarkImg, state.currentMockup.originalWidth, state.currentMockup.originalHeight, 0.5);

            overlay.classList.add('active');
        }

        // Folder System
        function saveFoldersToDB() {
            try {
                localStorage.setItem('tierpod_folders', JSON.stringify(state.folders));
                localStorage.setItem('tierpod_mockup_folders', JSON.stringify(state.mockupToFolder));
                localStorage.setItem('tierpod_current_folder', state.currentFolderId);
            } catch (e) {
                console.error('Error saving folders:', e);
            }
        }

        function loadFoldersFromDB() {
            try {
                const savedFolders = localStorage.getItem('tierpod_folders');
                const savedMockupFolders = localStorage.getItem('tierpod_mockup_folders');
                const savedCurrentFolder = localStorage.getItem('tierpod_current_folder');

                if (savedFolders) {
                    state.folders = JSON.parse(savedFolders);
                } else {
                    state.folders = [
                        { id: 'all', name: 'All Mockups', icon: 'fa-images', color: '#667eea' }
                    ];
                }

                if (savedMockupFolders) {
                    state.mockupToFolder = JSON.parse(savedMockupFolders);
                }

                if (savedCurrentFolder) {
                    state.currentFolderId = savedCurrentFolder;
                }
            } catch (e) {
                console.error('Error loading folders:', e);
                state.folders = [
                    { id: 'all', name: 'All Mockups', icon: 'fa-images', color: '#667eea' }
                ];
            }
        }

        function createFolder(name, icon = 'fa-folder', color = '#667eea') {
            const folderId = 'folder_' + Date.now();
            const newFolder = { id: folderId, name: name, icon: icon, color: color };
            state.folders.push(newFolder);
            saveFoldersToDB();
            renderFolderList();
            return folderId;
        }

        function deleteFolder(folderId) {
            if (folderId === 'all') {
                alert('Cannot delete "All Mockups" folder');
                return;
            }

            if (!confirm('Delete this folder? Templates will move to "All Mockups".')) {
                return;
            }

            for (const mockupId in state.mockupToFolder) {
                if (state.mockupToFolder[mockupId] === folderId) {
                    delete state.mockupToFolder[mockupId];
                }
            }

            state.folders = state.folders.filter(f => f.id !== folderId);

            if (state.currentFolderId === folderId) {
                state.currentFolderId = 'all';
            }

            saveFoldersToDB();
            renderFolderList();
            renderMockupList();
            updateCurrentFolderBadge();
        }

        function assignMockupToFolder(mockupId, folderId) {
            if (folderId === 'all') {
                delete state.mockupToFolder[mockupId];
            } else {
                state.mockupToFolder[mockupId] = folderId;
            }
            saveFoldersToDB();
            renderMockupList();
            renderFolderList();
        }

        function getMockupsInFolder(folderId) {
            if (folderId === 'all') {
                return state.mockups;
            }
            return state.mockups.filter(m => state.mockupToFolder[m.id] === folderId);
        }

        function getMockupCount(folderId) {
            return getMockupsInFolder(folderId).length;
        }

        function switchFolder(folderId) {
            state.currentFolderId = folderId;
            saveFoldersToDB();
            renderFolderList();
            renderMockupList();
            updateCurrentFolderBadge();
            updateGenerateButton();
        }

        function updateCurrentFolderBadge() {
            const badge = document.getElementById('currentFolderBadge');
            const folder = state.folders.find(f => f.id === state.currentFolderId);
            if (badge && folder) {
                badge.textContent = folder.name;
                badge.style.display = 'inline-block';
            }
        }

        function renderFolderList() {
            const folderList = document.getElementById('folderList');
            if (!folderList) return;

            folderList.innerHTML = '';

            for (const folder of state.folders) {
                const count = getMockupCount(folder.id);
                const li = document.createElement('li');
                li.className = 'folder-item';
                if (folder.id === state.currentFolderId) {
                    li.classList.add('active');
                }

                const deleteBtn = folder.id !== 'all' ? 
                    `<button class="folder-delete-btn" onclick="event.stopPropagation(); deleteFolder('${folder.id}')"><i class="fas fa-trash"></i></button>` : '';

                li.innerHTML = `
                    <i class="fas ${folder.icon} folder-icon" style="color: ${folder.id === state.currentFolderId ? 'white' : folder.color};"></i>
                    <span class="folder-name">${folder.name}</span>
                    <span class="folder-count">${count}</span>
                    ${deleteBtn}
                `;

                li.onclick = () => switchFolder(folder.id);
                folderList.appendChild(li);
            }
        }

        let selectedFolderIcon = 'fa-folder';
        let selectedFolderColor = '#667eea';

        function openFolderModal() {
            const modal = document.getElementById('folderModal');
            const input = document.getElementById('folderNameInput');

            if (modal && input) {
                modal.classList.add('active');
                input.value = '';
                input.focus();

                selectedFolderIcon = 'fa-folder';
                selectedFolderColor = '#667eea';

                document.querySelectorAll('.folder-icon-option').forEach(el => {
                    el.classList.toggle('selected', el.dataset.icon === 'fa-folder');
                });

                document.querySelectorAll('.folder-color-option').forEach(el => {
                    el.classList.toggle('selected', el.dataset.color === '#667eea');
                });
            }
        }

        // Library System
        function openLibraryModal() {
            const modal = document.getElementById('libraryModal');
            modal.classList.add('active');

            state.selectedLibraryMockups.clear();
            updateLibrarySelectionInfo();

            renderLibraryCategories();

            const firstCategory = Object.keys(LIBRARY_CONFIG.categories)[0];
            if (firstCategory) {
                loadLibraryCategory(firstCategory);
            }
        }

        function renderLibraryCategories() {
            const container = document.getElementById('libraryCategories');
            container.innerHTML = '';

            for (const [categoryId, category] of Object.entries(LIBRARY_CONFIG.categories)) {
                const btn = document.createElement('div');
                btn.className = 'category-btn';
                btn.innerHTML = `
                    <i class="fas ${category.icon}"></i>
                    <div>${category.name}</div>
                    <small style="color: var(--gray); font-size: 0.8em;">${category.mockups.length} mockups</small>
                `;
                btn.onclick = () => loadLibraryCategory(categoryId);
                container.appendChild(btn);
            }
        }

        async function loadLibraryCategory(categoryId) {
            state.currentLibraryCategory = categoryId;
            state.selectedLibraryMockups.clear();
            updateLibrarySelectionInfo();

            document.querySelectorAll('.category-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', Object.keys(LIBRARY_CONFIG.categories)[idx] === categoryId);
            });

            const category = LIBRARY_CONFIG.categories[categoryId];
            const container = document.getElementById('libraryMockups');
            const loadingState = document.getElementById('libraryLoadingState');

            container.style.display = 'none';
            loadingState.style.display = 'block';

            container.innerHTML = '';

            for (const mockupFile of category.mockups) {
                const thumbnailUrl = `${LIBRARY_CONFIG.baseUrl}/${category.thumbnailFolder}/${mockupFile}`;
                const fullQualityUrl = `${LIBRARY_CONFIG.baseUrl}/${categoryId}/${mockupFile}`;

                const item = document.createElement('div');
                item.className = 'library-mockup-item';
                item.dataset.mockupFile = mockupFile;
                item.dataset.categoryId = categoryId;
                item.dataset.thumbnailUrl = thumbnailUrl;
                item.dataset.fullQualityUrl = fullQualityUrl;

                const checkbox = document.createElement('div');
                checkbox.className = 'library-mockup-checkbox';
                checkbox.innerHTML = '<i class="fas fa-check"></i>';
                item.appendChild(checkbox);

                const img = document.createElement('img');
                img.className = 'library-mockup-img';
                img.src = thumbnailUrl;
                img.alt = mockupFile;
                img.onerror = () => {
                    img.src = fullQualityUrl;
                };

                const name = document.createElement('div');
                name.className = 'library-mockup-name';
                name.textContent = mockupFile.replace('.jpg', '').replace('.png', '');

                item.appendChild(img);
                item.appendChild(name);

                item.onclick = () => toggleLibraryMockupSelection(item);

                container.appendChild(item);
            }

            await new Promise(resolve => setTimeout(resolve, 300));
            loadingState.style.display = 'none';
            container.style.display = 'grid';
        }

        function toggleLibraryMockupSelection(item) {
            const mockupId = `${item.dataset.categoryId}:${item.dataset.mockupFile}`;

            if (state.selectedLibraryMockups.has(mockupId)) {
                state.selectedLibraryMockups.delete(mockupId);
                item.classList.remove('selected');
            } else {
                state.selectedLibraryMockups.add(mockupId);
                item.classList.add('selected');
            }

            updateLibrarySelectionInfo();
        }

        function updateLibrarySelectionInfo() {
            const count = state.selectedLibraryMockups.size;
            document.getElementById('librarySelectionInfo').textContent = `${count} selected`;
            document.getElementById('addSelectedMockupsBtn').disabled = count === 0;
        }

        async function addMockupFromLibrary(url, filename) {
            const response = await fetch(url);
            const blob = await response.blob();

            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const img = new Image();
                    img.onload = async () => {
                        const mockup = {
                            id: 'mockup_' + Date.now() + '_' + Math.random(),
                            name: filename,
                            dataUrl: e.target.result,
                            originalWidth: img.width,
                            originalHeight: img.height,
                            fromLibrary: true
                        };

                        await saveMockupToDB(mockup);
                        state.mockups.push(mockup);
                        state.mockupEnabled[mockup.id] = true;

                        if (state.currentFolderId !== 'all') {
                            state.mockupToFolder[mockup.id] = state.currentFolderId;
                            saveFoldersToDB();
                        }

                        // TASK 1: Immediate UI refresh
                        renderFolderList();
                        renderMockupList();
                        updateStats();
                        updateGenerateButton();

                        resolve();
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // Mockup Management
        async function loadMockupsFromDB() {
            try {
                state.mockups = await getAllMockupsFromDB();
                const savedData = localStorage.getItem('tierpod_positions');
                if (savedData) {
                    state.savedMockupData = JSON.parse(savedData);
                }
                const enabledData = localStorage.getItem('tierpod_enabled');
                if (enabledData) {
                    state.mockupEnabled = JSON.parse(enabledData);
                } else {
                    state.mockups.forEach(m => {
                        if (state.mockupEnabled[m.id] === undefined) {
                            state.mockupEnabled[m.id] = true;
                        }
                    });
                }
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        async function updateStorageMeter() {
            try {
                const size = await getDBSize();
                const sizeMB = (size / (1024 * 1024)).toFixed(2);
                const limit = 500 * 1024 * 1024;
                const percent = Math.min((size / limit) * 100, 100);

                document.getElementById('storageSize').textContent = sizeMB + ' MB';
                document.getElementById('storagePercent').textContent = percent.toFixed(0) + '%';
                document.getElementById('storageFill').style.width = percent + '%';

                if (percent > 80) {
                    document.getElementById('storageFill').classList.add('warning');
                } else {
                    document.getElementById('storageFill').classList.remove('warning');
                }
            } catch (error) {
                console.error('Storage meter error:', error);
            }
        }

        function updateStats() {
            document.getElementById('mockupCount').textContent = state.mockups.length;
        }

        function savePositionsToStorage() {
            try {
                localStorage.setItem('tierpod_positions', JSON.stringify(state.savedMockupData));
            } catch (e) {
                console.error('Position save error:', e);
            }
        }

        function toggleMockup(mockupId) {
            const currentState = state.mockupEnabled[mockupId];
            const newState = (currentState === false) ? true : false;
            state.mockupEnabled[mockupId] = newState;

            localStorage.setItem('tierpod_enabled', JSON.stringify(state.mockupEnabled));
            renderMockupList();
            updateGenerateButton();
        }

        async function deleteMockup(mockupId) {
            if (!confirm(' Delete this template? This cannot be undone.')) {
                return;
            }

            try {
                await deleteMockupFromDB(mockupId);
                state.mockups = state.mockups.filter(m => m.id !== mockupId);
                delete state.savedMockupData[mockupId];
                delete state.mockupToFolder[mockupId];
                savePositionsToStorage();
                saveFoldersToDB();

                if (state.currentMockup && state.currentMockup.id === mockupId) {
                    state.currentMockup = null;
                    document.getElementById('mockupPreview').classList.remove('visible');
                    document.querySelector('.preview-placeholder').style.display = 'block';
                    clearDesignElements();
                    document.getElementById('addPngBtn').disabled = true;
                }

                renderFolderList();
                renderMockupList();
                updateStats();
                updateGenerateButton();
                await updateStorageMeter();

            } catch (error) {
                console.error('Delete error:', error);
                alert(' Error deleting template');
            }
        }

        async function clearStorage() {
            if (confirm(' Clear all templates and positions?')) {
                try {
                    await clearAllDB();
                    localStorage.clear();
                    state.mockups = [];
                    state.savedMockupData = {};
                    state.mockupEnabled = {};
                    state.currentMockup = null;
                    state.folders = [{ id: 'all', name: 'All Mockups', icon: 'fa-images', color: '#667eea' }];
                    state.mockupToFolder = {};
                    state.currentFolderId = 'all';
                    state.selectedWatermark = null;
                    clearDesignElements();
                    renderFolderList();
                    renderMockupList();
                    updateStats();
                    updateCurrentFolderBadge();
                    updateGenerateButton();
                    await updateStorageMeter();
                    await loadWatermarks();
                    alert(' All data cleared!');
                } catch (error) {
                    console.error('Clear error:', error);
                    alert(' Error clearing data');
                }
            }
        }

        let contextMenuMockupId = null;

        function showMockupFolderMenu(mockupId, event) {
            event.stopPropagation();
            document.querySelectorAll('.folder-context-menu').forEach(el => el.remove());

            contextMenuMockupId = mockupId;

            const menu = document.createElement('div');
            menu.className = 'folder-context-menu';
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';

            for (const folder of state.folders) {
                const item = document.createElement('div');
                item.className = 'folder-context-menu-item';
                item.innerHTML = `
                    <i class="fas ${folder.icon}" style="color: ${folder.color};"></i>
                    <span>${folder.name}</span>
                `;
                item.onclick = () => {
                    assignMockupToFolder(mockupId, folder.id);
                    menu.remove();
                };
                menu.appendChild(item);
            }

            document.body.appendChild(menu);

            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                });
            }, 100);
        }

        const mockupInput = document.getElementById('mockupFilesInput');
        mockupInput.addEventListener('change', (e) => {
            handleMockupFiles(e.target.files);
        });

        async function handleMockupFiles(files) {
            for (const file of Array.from(files)) {
                try {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const img = new Image();
                        img.onload = async () => {
                            const mockup = {
                                id: 'mockup_' + Date.now() + '_' + Math.random(),
                                name: file.name,
                                dataUrl: e.target.result,
                                originalWidth: img.width,
                                originalHeight: img.height,
                                fromLibrary: false
                            };

                            await saveMockupToDB(mockup);
                            state.mockups.push(mockup);
                            state.mockupEnabled[mockup.id] = true;

                            if (state.currentFolderId !== 'all') {
                                state.mockupToFolder[mockup.id] = state.currentFolderId;
                                saveFoldersToDB();
                            }

                            renderFolderList();
                            renderMockupList();
                            updateStats();
                            updateGenerateButton();
                            await updateStorageMeter();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error('Upload error:', error);
                    alert(' Error uploading file');
                }
            }
        }

        function renderMockupList() {
            const mockupList = document.getElementById('mockupList');

            const mockupsToShow = getMockupsInFolder(state.currentFolderId);

            if (mockupsToShow.length === 0) {
                mockupList.innerHTML = `
                    <li class="empty-state" style="padding: 30px 16px;">
                        <i class="fas fa-image"></i>
                        <p>No templates in this folder</p>
                    </li>
                `;
                return;
            }

            mockupList.innerHTML = mockupsToShow.map(m => {
                const saved = state.savedMockupData[m.id];
                const elementCount = saved ? saved.elements.length : 0;
                const isEnabled = state.mockupEnabled[m.id] !== false;
                const libraryBadge = m.fromLibrary ? '<span class="library-badge">LIB</span>' : '';
                return `
                    <li class="mockup-item ${state.currentMockup?.id === m.id ? 'selected' : ''} ${!isEnabled ? 'disabled' : ''}" 
                        data-id="${m.id}">
                        <div class="mockup-name">
                            <i class="fas fa-image"></i>
                            <span>${m.name}</span>
                            ${libraryBadge}
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            ${elementCount > 0 ? `<div class="mockup-badge"><i class="fas fa-check"></i> ${elementCount}</div>` : ''}
                            <button class="mockup-folder-btn" onclick="event.stopPropagation(); showMockupFolderMenu('${m.id}', event)" title="Move to folder">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="mockup-toggle ${isEnabled ? 'enabled' : ''}" onclick="event.stopPropagation(); toggleMockup('${m.id}')" title="${isEnabled ? 'Enabled' : 'Disabled'}">
                                <div class="mockup-toggle-slider"></div>
                            </div>
                            <button class="delete-mockup-btn" onclick="event.stopPropagation(); deleteMockup('${m.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </li>
                `;
            }).join('');

            document.querySelectorAll('.mockup-item').forEach(item => {
                item.addEventListener('click', () => selectMockup(item.dataset.id));
            });
        }

        function selectMockup(id) {
            if (state.currentMockup && state.designElements.length > 0) {
                saveCurrentMockupElements();
            }

            state.currentMockup = state.mockups.find(m => m.id === id);

            const mockupPreview = document.getElementById('mockupPreview');
            mockupPreview.src = state.currentMockup.dataUrl;
            mockupPreview.classList.add('visible');
            document.querySelector('.preview-placeholder').style.display = 'none';

            clearDesignElements();

            if (state.savedMockupData[id]) {
                const savedData = state.savedMockupData[id];
                mockupPreview.onload = () => {
                    savedData.elements.forEach(elementData => {
                        createDesignElement(elementData);
                    });
                };
            }

            document.getElementById('addPngBtn').disabled = false;
            document.getElementById('opacitySlider').disabled = false;

            renderMockupList();
            updateGenerateButton();

            // TASK 2: Show watermark if selected
            setTimeout(() => updateWatermarkPreview(), 100);
        }

        // Design Elements
        document.getElementById('addPngBtn').addEventListener('click', () => {
            if (!state.currentMockup) return;

            const mockupPreview = document.getElementById('mockupPreview');
            const previewContainer = document.getElementById('previewContainer');
            const mockupRect = mockupPreview.getBoundingClientRect();
            const containerRect = previewContainer.getBoundingClientRect();

            let width = 200, height = 200;

            if (state.currentAspectRatio !== 'free') {
                const ratio = state.currentAspectRatio.split(':');
                const w = parseInt(ratio[0]);
                const h = parseInt(ratio[1]);
                width = 200;
                height = (width * h) / w;
            }

            const elementData = {
                id: 'element_' + (++elementIdCounter),
                left: mockupRect.left - containerRect.left + 50,
                top: mockupRect.top - containerRect.top + 50,
                width: width,
                height: height,
                rotation: 0,
                opacity: parseFloat(document.getElementById('opacitySlider').value),
                aspectRatio: state.currentAspectRatio
            };

            createDesignElement(elementData);
            document.getElementById('savePositionBtn').disabled = false;
        });

        function createDesignElement(data) {
            const wrapper = document.createElement('div');
            wrapper.className = 'design-wrapper';
            wrapper.dataset.id = data.id;
            wrapper.style.left = data.left + 'px';
            wrapper.style.top = data.top + 'px';
            wrapper.style.width = data.width + 'px';
            wrapper.style.height = data.height + 'px';
            wrapper.style.transform = `rotate(${data.rotation}deg)`;
            wrapper.style.opacity = data.opacity;

            const elementNum = state.designElements.length + 1;
            wrapper.innerHTML = `
                <div class="element-label">Element ${elementNum}</div>
                <div class="design-placeholder">
                    <i class="fas fa-layer-group" style="font-size: 1.8em; margin-bottom: 6px;"></i>
                    <div>Design Area</div>
                    <div style="font-size: 10px; margin-top: 3px;">${Math.round(data.width)}  ${Math.round(data.height)}</div>
                </div>
                <div class="resize-handle"></div>
                <div class="rotate-handle"><i class="fas fa-rotate"></i></div>
                <div class="remove-handle"></div>
            `;

            document.getElementById('previewContainer').appendChild(wrapper);
            state.designElements.push({ id: data.id, element: wrapper, data: data });

            setupElementInteractions(wrapper, data);

            wrapper.addEventListener('click', (e) => {
                if (!e.target.closest('.remove-handle')) {
                    setActiveElement(wrapper);
                }
            });

            setActiveElement(wrapper);
        }

        function setActiveElement(wrapper) {
            document.querySelectorAll('.design-wrapper').forEach(w => w.classList.remove('active'));
            wrapper.classList.add('active');
            state.activeElement = wrapper;
        }

        function setupElementInteractions(wrapper, data) {
            let isDragging = false, isResizing = false, isRotating = false;
            let startX, startY, initialLeft, initialTop, startWidth, startHeight;
            let centerX, centerY, startAngle, currentRotation = 0;

            wrapper.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('resize-handle') || 
                    e.target.closest('.rotate-handle') ||
                    e.target.closest('.remove-handle')) return;

                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialLeft = parseInt(wrapper.style.left);
                initialTop = parseInt(wrapper.style.top);
                setActiveElement(wrapper);
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    wrapper.style.left = (initialLeft + dx) + 'px';
                    wrapper.style.top = (initialTop + dy) + 'px';
                    data.left = parseInt(wrapper.style.left);
                    data.top = parseInt(wrapper.style.top);
                }

                if (isResizing) {
                    const dx = e.clientX - startX;
                    let newWidth = Math.max(50, startWidth + dx);
                    let newHeight = Math.max(50, startHeight + (dx * (startHeight / startWidth)));

                    if (data.aspectRatio !== 'free') {
                        const ratio = data.aspectRatio.split(':');
                        const w = parseInt(ratio[0]);
                        const h = parseInt(ratio[1]);
                        newHeight = (newWidth * h) / w;
                    }

                    wrapper.style.width = newWidth + 'px';
                    wrapper.style.height = newHeight + 'px';
                    data.width = newWidth;
                    data.height = newHeight;
                }

                if (isRotating) {
                    const angle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
                    const rotation = currentRotation + (angle - startAngle) * (180 / Math.PI);
                    wrapper.style.transform = `rotate(${rotation}deg)`;
                    data.rotation = rotation;
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = isResizing = isRotating = false;
            });

            wrapper.querySelector('.resize-handle').addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                startWidth = parseInt(wrapper.style.width);
                startHeight = parseInt(wrapper.style.height);
                e.stopPropagation();
                e.preventDefault();
            });

            wrapper.querySelector('.rotate-handle').addEventListener('mousedown', (e) => {
                isRotating = true;
                const rect = wrapper.getBoundingClientRect();
                centerX = rect.left + rect.width / 2;
                centerY = rect.top + rect.height / 2;
                startAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
                const match = wrapper.style.transform.match(/rotate\(([^)]+)deg\)/);
                currentRotation = match ? parseFloat(match[1]) : 0;
                e.stopPropagation();
                e.preventDefault();
            });

            wrapper.querySelector('.remove-handle').addEventListener('click', () => {
                wrapper.remove();
                state.designElements = state.designElements.filter(e => e.id !== data.id);
                if (state.designElements.length === 0) {
                    document.getElementById('savePositionBtn').disabled = true;
                }
                if (state.activeElement === wrapper) {
                    state.activeElement = null;
                }
            });
        }

        document.getElementById('opacitySlider').addEventListener('input', (e) => {
            const opacity = parseFloat(e.target.value);
            document.getElementById('opacityValue').textContent = Math.round(opacity * 100) + '%';

            if (state.activeElement) {
                state.activeElement.style.opacity = opacity;
                const elementData = state.designElements.find(el => el.element === state.activeElement);
                if (elementData) elementData.data.opacity = opacity;
            }
        });

        document.querySelectorAll('.aspect-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.aspect-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.currentAspectRatio = btn.dataset.ratio;
                document.getElementById('customRatioInput').classList.toggle('active', btn.dataset.ratio === 'custom');

                if (state.activeElement) {
                    const elementData = state.designElements.find(el => el.element === state.activeElement);
                    if (elementData) {
                        applyAspectRatioToElement(elementData, btn.dataset.ratio);
                    }
                }
            });
        });

        function applyAspectRatioToElement(elementData, ratio) {
            elementData.data.aspectRatio = ratio;

            if (ratio !== 'free') {
                const ratioSplit = ratio.split(':');
                const w = parseInt(ratioSplit[0]);
                const h = parseInt(ratioSplit[1]);
                const currentWidth = elementData.data.width;
                const newHeight = (currentWidth * h) / w;

                state.activeElement.style.height = newHeight + 'px';
                elementData.data.height = newHeight;
            }
        }

        function applyCustomRatio() {
            const w = parseInt(document.getElementById('ratioWidth').value) || 1;
            const h = parseInt(document.getElementById('ratioHeight').value) || 1;
            state.currentAspectRatio = `${w}:${h}`;

            if (state.activeElement) {
                const elementData = state.designElements.find(el => el.element === state.activeElement);
                if (elementData) {
                    applyAspectRatioToElement(elementData, `${w}:${h}`);
                }
                alert(` Custom ratio applied: ${w}:${h}`);
            }
        }

        document.getElementById('savePositionBtn').addEventListener('click', () => {
            if (!state.currentMockup || state.designElements.length === 0) return;

            saveCurrentMockupElements();
            savePositionsToStorage();

            renderMockupList();
            updateGenerateButton();

            alert(' Saved!');
        });

        function saveCurrentMockupElements() {
            if (!state.currentMockup) return;

            const mockupPreview = document.getElementById('mockupPreview');
            const previewContainer = document.getElementById('previewContainer');
            const mockupRect = mockupPreview.getBoundingClientRect();
            const containerRect = previewContainer.getBoundingClientRect();

            state.savedMockupData[state.currentMockup.id] = {
                elements: state.designElements.map(el => ({...el.data})),
                previewBounds: {
                    width: mockupRect.width,
                    height: mockupRect.height,
                    left: mockupRect.left - containerRect.left,
                    top: mockupRect.top - containerRect.top
                }
            };
        }

        function clearDesignElements() {
            document.querySelectorAll('.design-wrapper').forEach(el => el.remove());
            state.designElements = [];
            state.activeElement = null;
        }

        function updateGenerateButton() {
            const mockupsInCurrentFolder = getMockupsInFolder(state.currentFolderId);
            const enabledInFolder = mockupsInCurrentFolder.filter(m => 
                state.mockupEnabled[m.id] !== false && state.savedMockupData[m.id]
            );

            const hasData = enabledInFolder.length > 0;
            document.getElementById('loadExportBtn').disabled = !hasData;

            const btn = document.getElementById('loadExportBtn');
            if (hasData) {
                const count = enabledInFolder.length;
                btn.innerHTML = `<i class="fas fa-rocket"></i><span>Generate ${count} Template${count > 1 ? 's' : ''}</span>`;
            } else {
                btn.innerHTML = '<i class="fas fa-rocket"></i><span>Generate & Download</span>';
            }
        }

        // Export with Tiled Watermark (TASK 2)
        document.getElementById('loadExportBtn').addEventListener('click', () => {
            document.getElementById('designPngsInput').click();
        });

        document.getElementById('designPngsInput').addEventListener('change', async (e) => {
            const pngFiles = Array.from(e.target.files);
            if (pngFiles.length === 0) return;

            const progressModal = document.getElementById('progressModal');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            progressModal.classList.add('active');

            const mockupsInCurrentFolder = getMockupsInFolder(state.currentFolderId);
            const mockupsWithData = mockupsInCurrentFolder
                .filter(m => state.mockupEnabled[m.id] !== false && state.savedMockupData[m.id])
                .map(m => m.id);

            console.log('=== EXPORT DEBUG ===');
            console.log('Watermark:', state.selectedWatermark || 'None');
            console.log('Will export:', mockupsWithData.length, 'mockups');

            if (mockupsWithData.length === 0) {
                progressModal.classList.remove('active');
                alert(' No enabled templates!');
                return;
            }

            const total = pngFiles.length * mockupsWithData.length;
            let completed = 0;

            const zip = new JSZip();

            for (const pngFile of pngFiles) {
                const pngDataUrl = await readFileAsDataURL(pngFile);
                const pngImg = await loadImage(pngDataUrl);

                for (const mockupId of mockupsWithData) {
                    const mockup = state.mockups.find(m => m.id === mockupId);
                    const savedData = state.savedMockupData[mockupId];

                    const mockupImg = await loadImage(mockup.dataUrl);

                    const canvas = document.createElement('canvas');
                    canvas.width = mockup.originalWidth;
                    canvas.height = mockup.originalHeight;

                    const mockupExtension = mockup.name.toLowerCase();
                    const isPNG = mockupExtension.endsWith('.png');

                    const ctx = canvas.getContext('2d', { 
                        alpha: isPNG,
                        willReadFrequently: false 
                    });

                    // Draw mockup
                    ctx.drawImage(mockupImg, 0, 0, mockup.originalWidth, mockup.originalHeight);

                    const scaleX = mockup.originalWidth / savedData.previewBounds.width;
                    const scaleY = mockup.originalHeight / savedData.previewBounds.height;

                    // Draw design elements
                    for (const element of savedData.elements) {
                        ctx.save();

                        const scaledLeft = (element.left - savedData.previewBounds.left) * scaleX;
                        const scaledTop = (element.top - savedData.previewBounds.top) * scaleY;
                        const scaledWidth = element.width * scaleX;
                        const scaledHeight = element.height * scaleY;

                        ctx.globalAlpha = element.opacity;
                        ctx.translate(scaledLeft + scaledWidth/2, scaledTop + scaledHeight/2);
                        ctx.rotate(element.rotation * Math.PI / 180);

                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';

                        ctx.drawImage(pngImg, -scaledWidth/2, -scaledHeight/2, scaledWidth, scaledHeight);

                        ctx.restore();
                    }

                    // TASK 2: Add tiled watermark
                    if (state.selectedWatermark && state.watermarkImages[state.selectedWatermark]) {
                        const watermarkImg = state.watermarkImages[state.selectedWatermark];
                        drawTiledWatermark(ctx, watermarkImg, mockup.originalWidth, mockup.originalHeight, 0.8);
                        console.log(' Tiled watermark applied');
                    }

                    const baseName = pngFile.name.replace(/\.(png|jpg|jpeg)$/i, '');
                    let dataUrl, finalFileName;

                    if (isPNG) {
                        dataUrl = canvas.toDataURL('image/png');
                        finalFileName = `${baseName}_${mockup.name}`;
                    } else {
                        dataUrl = canvas.toDataURL('image/jpeg', 1.0);
                        const mockupBaseName = mockup.name.replace(/\.(png|jpg|jpeg)$/i, '');
                        finalFileName = `${baseName}_${mockupBaseName}.jpg`;
                    }

                    const base64 = dataUrl.split(',')[1];
                    zip.file(finalFileName, base64, { base64: true });

                    completed++;
                    const progress = Math.round((completed / total) * 100);
                    progressFill.style.width = progress + '%';
                    progressFill.textContent = progress + '%';
                    progressText.textContent = `Generated ${completed} of ${total}...`;

                    await new Promise(resolve => setTimeout(resolve, 50));
                }
            }

            if (total === 1) {
                progressText.textContent = 'Downloading...';

                const firstFile = zip.file(Object.keys(zip.files)[0]);
                const base64Data = await firstFile.async('base64');

                const link = document.createElement('a');
                link.download = Object.keys(zip.files)[0];
                link.href = 'data:image/png;base64,' + base64Data;
                link.click();

                setTimeout(() => {
                    progressModal.classList.remove('active');
                    alert(` Generated 1 mockup!${state.selectedWatermark ? '\n With tiled watermark' : ''}`);
                    document.getElementById('designPngsInput').value = '';
                }, 500);

            } else {
                progressText.textContent = 'Creating ZIP...';
                const blob = await zip.generateAsync({ type: 'blob' });
                const link = document.createElement('a');
                const folderName = state.folders.find(f => f.id === state.currentFolderId)?.name || 'mockups';
                link.download = `${folderName.replace(/\s+/g, '_')}_${Date.now()}.zip`;
                link.href = URL.createObjectURL(blob);
                link.click();

                setTimeout(() => {
                    progressModal.classList.remove('active');
                    alert(` Generated ${total} mockups!${state.selectedWatermark ? '\n With tiled watermark' : ''}`);
                    document.getElementById('designPngsInput').value = '';
                }, 500);
            }
        });

        function readFileAsDataURL(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
        }

        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error('Failed to load image: ' + src));
                img.crossOrigin = 'anonymous';
                img.src = src;
            });
        }

        // Event Listeners
        window.addEventListener('load', async () => {
            try {
                await initDB();
                await loadMockupsFromDB();
                loadFoldersFromDB();
                await loadWatermarks();
                await updateStorageMeter();
                renderFolderList();
                renderMockupList();
                updateStats();
                updateCurrentFolderBadge();
                updateGenerateButton();

                setupEventListeners();
            } catch (error) {
                console.error('Init error:', error);
                alert(' Database initialization failed');
            }
        });

        function setupEventListeners() {
            document.getElementById('uploadDesktopBtn')?.addEventListener('click', () => {
                document.getElementById('mockupFilesInput').click();
            });

            document.getElementById('browseLibraryBtn')?.addEventListener('click', openLibraryModal);
            document.getElementById('closeLibraryModal')?.addEventListener('click', () => {
                document.getElementById('libraryModal').classList.remove('active');
            });

            document.getElementById('addFolderBtnInline')?.addEventListener('click', openFolderModal);
            document.getElementById('cancelFolderBtn')?.addEventListener('click', () => {
                document.getElementById('folderModal')?.classList.remove('active');
            });

            document.getElementById('createFolderBtn')?.addEventListener('click', () => {
                const input = document.getElementById('folderNameInput');
                const name = input?.value.trim();

                if (!name) {
                    alert('Please enter a folder name');
                    return;
                }

                const folderId = createFolder(name, selectedFolderIcon, selectedFolderColor);
                document.getElementById('folderModal')?.classList.remove('active');
                switchFolder(folderId);
            });

            document.querySelectorAll('.folder-icon-option').forEach(el => {
                el.addEventListener('click', () => {
                    document.querySelectorAll('.folder-icon-option').forEach(e => e.classList.remove('selected'));
                    el.classList.add('selected');
                    selectedFolderIcon = el.dataset.icon;
                });
            });

            document.querySelectorAll('.folder-color-option').forEach(el => {
                el.addEventListener('click', () => {
                    document.querySelectorAll('.folder-color-option').forEach(e => e.classList.remove('selected'));
                    el.classList.add('selected');
                    selectedFolderColor = el.dataset.color;
                });
            });

            document.getElementById('folderNameInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('createFolderBtn')?.click();
                }
            });

            document.getElementById('foldersToggle')?.addEventListener('click', function() {
                toggleSection(this, 'foldersContent');
            });

            document.getElementById('watermarksToggle')?.addEventListener('click', function() {
                toggleSection(this, 'watermarksContent');
            });

            // Library multi-select (TASK 1)
            document.getElementById('selectAllBtn')?.addEventListener('click', () => {
                document.querySelectorAll('.library-mockup-item').forEach(item => {
                    const mockupId = `${item.dataset.categoryId}:${item.dataset.mockupFile}`;
                    state.selectedLibraryMockups.add(mockupId);
                    item.classList.add('selected');
                });
                updateLibrarySelectionInfo();
            });

            document.getElementById('deselectAllBtn')?.addEventListener('click', () => {
                state.selectedLibraryMockups.clear();
                document.querySelectorAll('.library-mockup-item').forEach(item => {
                    item.classList.remove('selected');
                });
                updateLibrarySelectionInfo();
            });

            document.getElementById('addSelectedMockupsBtn')?.addEventListener('click', async () => {
                if (state.selectedLibraryMockups.size === 0) return;

                const progressModal = document.getElementById('progressModal');
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');

                progressModal.classList.add('active');

                const selectedMockups = Array.from(state.selectedLibraryMockups);
                const total = selectedMockups.length;
                let completed = 0;

                for (const mockupId of selectedMockups) {
                    const [categoryId, mockupFile] = mockupId.split(':');

                    const fullQualityUrl = `${LIBRARY_CONFIG.baseUrl}/${categoryId}/${mockupFile}`;

                    progressText.textContent = `Loading ${mockupFile}... (${completed + 1}/${total})`;
                    progressFill.style.width = `${Math.round((completed / total) * 100)}%`;
                    progressFill.textContent = `${Math.round((completed / total) * 100)}%`;

                    try {
                        await addMockupFromLibrary(fullQualityUrl, mockupFile);
                        completed++;
                    } catch (error) {
                        console.error('Failed to load:', mockupFile, error);
                        completed++;
                    }

                    progressFill.style.width = `${Math.round((completed / total) * 100)}%`;
                    progressFill.textContent = `${Math.round((completed / total) * 100)}%`;
                }

                // TASK 1: Final UI refresh
                await updateStorageMeter();
                renderFolderList();
                renderMockupList();
                updateStats();
                updateGenerateButton();

                progressModal.classList.remove('active');
                document.getElementById('libraryModal').classList.remove('active');

                alert(` Added ${completed} mockup${completed > 1 ? 's' : ''} from library!`);
            });

            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
        }

        function toggleSection(header, contentId) {
            const content = document.getElementById(contentId);
            if (content) {
                header.classList.toggle('collapsed');
                content.classList.toggle('collapsed');
            }
        }
    </script>
</body>
</html>