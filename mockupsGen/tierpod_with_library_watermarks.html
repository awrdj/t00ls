<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TierPOD Pro - Professional Mockup Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --secondary: #764ba2;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --border: #e5e7eb;
            --dark: #1f2937;
            --gray: #6b7280;
            --light-bg: #f9fafb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--light-bg);
            color: var(--dark);
            overflow: hidden;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
            z-index: 100;
        }

        .sidebar-header {
            padding: 24px 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .sidebar-header h1 {
            font-size: 1.6em;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-header p {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .nav-menu {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .nav-section {
            margin-bottom: 20px;
        }

        .nav-section-header {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px;
            transition: background 0.2s;
            font-weight: 600;
            font-size: 0.9em;
            color: var(--dark);
        }

        .nav-section-header:hover {
            background: #f3f4f6;
        }

        .toggle-icon {
            transition: transform 0.3s;
        }

        .nav-section-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .nav-section-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .nav-section-content.collapsed {
            max-height: 0;
        }

        .folder-list {
            list-style: none;
            padding: 5px 0;
        }

        .folder-item {
            padding: 10px 15px;
            margin: 4px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
        }

        .folder-item:hover {
            background: #f3f4f6;
        }

        .folder-item.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .folder-icon {
            font-size: 1.1em;
            width: 20px;
            text-align: center;
        }

        .folder-name {
            flex: 1;
            font-size: 0.9em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .folder-count {
            background: rgba(255,255,255,0.3);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .folder-item.active .folder-count {
            background: rgba(255,255,255,0.4);
        }

        .folder-delete-btn {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            opacity: 0.6;
            transition: all 0.2s;
        }

        .folder-delete-btn:hover {
            opacity: 1;
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .add-folder-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
            margin: 10px 0;
        }

        .add-folder-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid var(--border);
            background: #f9fafb;
        }

        .stats-box {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.75em;
            color: var(--gray);
            margin-top: 2px;
        }

        .storage-meter {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        .storage-meter-label {
            font-size: 0.75em;
            color: var(--gray);
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
        }

        .storage-bar {
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
        }

        .storage-fill {
            height: 100%;
            background: linear-gradient(to right, var(--success), var(--info));
            transition: width 0.3s;
        }

        .storage-fill.warning {
            background: linear-gradient(to right, var(--warning), var(--danger));
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-bar {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            z-index: 50;
        }

        .top-bar h2 {
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .folder-badge {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.5em;
            font-weight: 600;
            margin-left: 8px;
        }

        .top-bar-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95em;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: white;
            border: 2px solid var(--border);
            color: var(--dark);
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .generator-wrapper {
            padding: 20px;
            height: calc(100vh - 70px);
        }

        .generator-grid {
            display: grid;
            grid-template-columns: 320px 1fr 280px;
            gap: 20px;
            height: 100%;
        }

        .panel {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow-lg);
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary);
        }

        .panel-title {
            font-size: 1.1em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .upload-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 16px;
        }

        .upload-btn {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            background: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        .upload-btn:hover {
            border-color: var(--primary);
            background: #f8faff;
            transform: translateY(-2px);
        }

        .upload-btn i {
            display: block;
            font-size: 1.8em;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .mockup-list {
            list-style: none;
        }

        .mockup-item {
            padding: 12px;
            margin: 8px 0;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }

        .mockup-item:hover {
            border-color: var(--primary);
            background: #f8faff;
            transform: translateX(4px);
        }

        .mockup-item.selected {
            background: linear-gradient(to right, #f0f4ff, #faf5ff);
            border-color: var(--primary);
            font-weight: 600;
        }

        .mockup-name {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            overflow: hidden;
        }

        .mockup-name span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.9em;
        }

        .mockup-badge {
            background: var(--success);
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .library-badge {
            background: var(--info);
            color: white;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 0.65em;
            font-weight: 700;
        }

        .mockup-toggle {
            position: relative;
            width: 36px;
            height: 20px;
            background: #d1d5db;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .mockup-toggle.enabled {
            background: var(--success);
        }

        .mockup-toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .mockup-toggle.enabled .mockup-toggle-slider {
            transform: translateX(16px);
        }

        .mockup-item.disabled {
            opacity: 0.5;
        }

        .mockup-item.disabled .mockup-name {
            text-decoration: line-through;
        }

        .mockup-folder-btn {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .mockup-folder-btn:hover {
            background: #f3f4f6;
            color: var(--primary);
        }

        .delete-mockup-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.75em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .delete-mockup-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .folder-context-menu {
            position: absolute;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            min-width: 200px;
            padding: 5px;
        }

        .folder-context-menu-item {
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }

        .folder-context-menu-item:hover {
            background: #f3f4f6;
        }

        .preview-wrapper {
            position: relative;
            background: linear-gradient(135deg, #667eea15, #764ba215);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            padding: 20px;
            border: 2px dashed var(--border);
            flex: 1;
        }

        .preview-container {
            position: relative;
            max-width: 100%;
            max-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #mockupPreview {
            max-width: 100%;
            max-height: 100%;
            display: none;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border-radius: 12px;
        }

        #mockupPreview.visible {
            display: block;
        }

        .preview-placeholder {
            text-align: center;
            color: var(--gray);
        }

        .preview-placeholder i {
            font-size: 5em;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .design-wrapper {
            position: absolute;
            border: 3px dashed var(--primary);
            cursor: move;
            background: rgba(102, 126, 234, 0.08);
            min-width: 50px;
            min-height: 50px;
        }

        .design-wrapper.active {
            border-color: var(--success);
            border-style: solid;
            background: rgba(16, 185, 129, 0.08);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .design-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--primary);
            text-align: center;
            padding: 8px;
            font-weight: 600;
        }

        .resize-handle {
            position: absolute;
            right: -8px;
            bottom: -8px;
            width: 22px;
            height: 22px;
            background: white;
            border: 3px solid var(--primary);
            cursor: nwse-resize;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .rotate-handle {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            width: 28px;
            height: 28px;
            background: var(--success);
            border-radius: 50%;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }

        .remove-handle {
            position: absolute;
            top: -14px;
            right: -14px;
            width: 32px;
            height: 32px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
            transition: transform 0.2s;
        }

        .remove-handle:hover {
            transform: scale(1.1);
        }

        .element-label {
            position: absolute;
            top: -32px;
            left: 0;
            background: var(--primary);
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            white-space: nowrap;
        }

        .controls-section {
            margin-bottom: 20px;
        }

        .controls-title {
            font-size: 0.95em;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .aspect-ratio-group {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .aspect-btn {
            flex: 1;
            padding: 8px;
            border: 2px solid var(--border);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .aspect-btn:hover {
            border-color: var(--primary);
        }

        .aspect-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .custom-ratio-input {
            display: none;
            gap: 8px;
            margin-top: 8px;
        }

        .custom-ratio-input.active {
            display: flex;
        }

        input[type="range"] {
            width: 100%;
            height: 5px;
            border-radius: 3px;
            background: #e5e7eb;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            cursor: pointer;
        }

        input[type="text"], input[type="number"] {
            padding: 8px 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.9em;
        }

        .watermark-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 12px;
        }

        .watermark-option {
            aspect-ratio: 1;
            border: 3px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .watermark-option:hover {
            border-color: var(--primary);
        }

        .watermark-option.selected {
            border-color: var(--success);
            background: #d1fae5;
        }

        .watermark-option img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .watermark-option.none {
            font-weight: 600;
            color: var(--gray);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 900px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h3 {
            font-size: 1.5em;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.8em;
            cursor: pointer;
            color: var(--gray);
        }

        .library-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .category-btn {
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            background: white;
        }

        .category-btn:hover {
            border-color: var(--primary);
            background: #f8faff;
        }

        .category-btn.active {
            border-color: var(--primary);
            background: linear-gradient(to bottom, #f0f4ff, #faf5ff);
        }

        .category-btn i {
            display: block;
            font-size: 2em;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .library-mockups {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .library-mockup-item {
            border: 2px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .library-mockup-item:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }

        .library-mockup-img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            background: #f9fafb;
        }

        .library-mockup-name {
            padding: 10px;
            font-size: 0.85em;
            font-weight: 600;
            text-align: center;
            border-top: 1px solid var(--border);
        }

        .folder-icon-grid, .folder-color-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .folder-icon-option, .folder-color-option {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .folder-icon-option:hover, .folder-color-option:hover {
            border-color: var(--primary);
        }

        .folder-icon-option.selected, .folder-color-option.selected {
            border-color: var(--primary);
            background: #f0f4ff;
        }

        .folder-color-option {
            height: 40px;
        }

        .progress-bar {
            height: 40px;
            background: #f3f4f6;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        .info-box {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-left: 3px solid var(--warning);
            padding: 12px;
            border-radius: 8px;
            font-size: 0.8em;
            line-height: 1.6;
            margin-top: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 4em;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-magic"></i> TierPOD Pro</h1>
                <p>Mockup Generator</p>
            </div>

            <div class="nav-menu">
                <!-- FOLDERS SECTION -->
                <div class="nav-section">
                    <div class="nav-section-header" id="foldersToggle">
                        <span><i class="fas fa-folder"></i> Folders</span>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="nav-section-content" id="foldersContent">
                        <button class="add-folder-btn" id="addFolderBtnInline">
                            <i class="fas fa-plus"></i>
                            New Folder
                        </button>
                        <ul class="folder-list" id="folderList"></ul>
                    </div>
                </div>

                <!-- WATERMARKS SECTION -->
                <div class="nav-section">
                    <div class="nav-section-header" id="watermarksToggle">
                        <span><i class="fas fa-droplet"></i> Watermark</span>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="nav-section-content" id="watermarksContent">
                        <div style="padding: 10px;">
                            <div class="watermark-grid" id="watermarkGrid">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STORAGE SECTION -->
                <div class="nav-section">
                    <div class="nav-section-header" onclick="showStorageInfo()" style="cursor: pointer;">
                        <span><i class="fas fa-info-circle"></i> Storage Info</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-header" onclick="clearStorage()" style="cursor: pointer;">
                        <span><i class="fas fa-trash-restore"></i> Clear All</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="stats-box">
                    <div class="stat-item">
                        <div class="stat-value" id="mockupCount">0</div>
                        <div class="stat-label">Templates</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="storageSize">0 MB</div>
                        <div class="stat-label">Storage</div>
                    </div>
                </div>
                <div class="storage-meter">
                    <div class="storage-meter-label">
                        <span><i class="fas fa-database"></i> IndexedDB</span>
                        <span id="storagePercent">0%</span>
                    </div>
                    <div class="storage-bar">
                        <div class="storage-fill" id="storageFill"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="top-bar">
                <h2>
                    <i class="fas fa-wand-magic-sparkles"></i>
                    <span>Generator</span>
                    <span class="folder-badge" id="currentFolderBadge" style="display: none;">All Mockups</span>
                </h2>
                <div class="top-bar-actions">
                    <button class="btn btn-secondary" onclick="alert('TierPOD Pro Guide:\n\n1. Upload or browse library mockups\n2. Add design elements\n3. Select watermark (optional)\n4. Save & generate!');">
                        <i class="fas fa-question-circle"></i>
                    </button>
                    <button class="btn btn-primary" id="loadExportBtn" disabled>
                        <i class="fas fa-rocket"></i>
                        <span>Generate & Download</span>
                    </button>
                </div>
            </div>

            <div class="generator-wrapper">
                <div class="generator-grid">
                    <!-- TEMPLATES PANEL -->
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">
                                <i class="fas fa-images"></i>
                                Templates
                            </h3>
                        </div>

                        <!-- UPLOAD OPTIONS -->
                        <div class="upload-options">
                            <div class="upload-btn" id="uploadDesktopBtn">
                                <i class="fas fa-upload"></i>
                                Upload from Desktop
                            </div>
                            <div class="upload-btn" id="browseLibraryBtn">
                                <i class="fas fa-book-open"></i>
                                Browse Library
                            </div>
                        </div>
                        <input type="file" id="mockupFilesInput" multiple accept="image/*" style="display: none;">

                        <ul class="mockup-list" id="mockupList">
                            <li class="empty-state" style="padding: 30px 16px;">
                                <i class="fas fa-image"></i>
                                <p>No templates</p>
                            </li>
                        </ul>
                    </div>

                    <!-- PREVIEW PANEL -->
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">
                                <i class="fas fa-eye"></i>
                                Live Preview
                            </h3>
                        </div>

                        <div class="preview-wrapper">
                            <div class="preview-container" id="previewContainer">
                                <div class="preview-placeholder">
                                    <i class="fas fa-image"></i>
                                    <p>Select a template</p>
                                </div>
                                <img id="mockupPreview" alt="Mockup Preview">
                            </div>
                        </div>

                        <div style="margin-top: 16px; display: flex; gap: 8px;">
                            <button class="btn btn-success" id="addPngBtn" disabled style="flex: 1;">
                                <i class="fas fa-plus"></i>
                                Add Element
                            </button>
                            <button class="btn btn-primary" id="savePositionBtn" disabled style="flex: 1;">
                                <i class="fas fa-save"></i>
                                Save
                            </button>
                        </div>
                    </div>

                    <!-- CONTROLS PANEL -->
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">
                                <i class="fas fa-sliders"></i>
                                Controls
                            </h3>
                        </div>

                        <div class="controls-section">
                            <div class="controls-title">
                                <i class="fas fa-crop"></i>
                                Aspect Ratio
                            </div>

                            <div class="aspect-ratio-group">
                                <button class="aspect-btn active" data-ratio="free">Free</button>
                                <button class="aspect-btn" data-ratio="5:6">5:6</button>
                                <button class="aspect-btn" data-ratio="1:1">1:1</button>
                                <button class="aspect-btn" data-ratio="4:5">4:5</button>
                            </div>

                            <div class="aspect-ratio-group">
                                <button class="aspect-btn" data-ratio="custom">Custom</button>
                            </div>

                            <div class="custom-ratio-input" id="customRatioInput">
                                <input type="number" id="ratioWidth" placeholder="W" min="1" value="1">
                                <span>:</span>
                                <input type="number" id="ratioHeight" placeholder="H" min="1" value="1">
                                <button class="btn btn-success" onclick="applyCustomRatio()" style="padding: 6px;">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </div>

                        <div class="controls-section">
                            <div class="controls-title">
                                <i class="fas fa-adjust"></i>
                                Opacity
                            </div>
                            <input type="range" id="opacitySlider" min="0" max="1" step="0.01" value="1" disabled>
                            <div style="text-align: center; margin-top: 5px; font-weight: 600; color: var(--primary);" id="opacityValue">100%</div>
                        </div>

                        <div class="info-box">
                            <strong><i class="fas fa-lightbulb"></i> Quick Guide</strong>
                            <ol style="margin-left: 15px;">
                                <li>Upload or browse templates</li>
                                <li>Add design elements</li>
                                <li>Select watermark (optional)</li>
                                <li>Save & generate</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- LIBRARY MODAL -->
    <div class="modal" id="libraryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-book-open"></i> Mockup Library</h3>
                <button class="close-modal" id="closeLibraryModal">×</button>
            </div>

            <div class="library-categories" id="libraryCategories">
                <!-- Populated by JS -->
            </div>

            <div id="libraryLoadingState" style="display: none;">
                <div class="loading-spinner"></div>
                <p style="text-align: center; color: var(--gray);">Loading mockups...</p>
            </div>

            <div class="library-mockups" id="libraryMockups">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- FOLDER MODAL -->
    <div class="modal" id="folderModal">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-header">
                <h3><i class="fas fa-folder-plus"></i> New Folder</h3>
                <button class="close-modal" id="cancelFolderBtn">×</button>
            </div>
            <div>
                <label style="font-weight: 600; display: block; margin-bottom: 8px;">Folder Name</label>
                <input type="text" id="folderNameInput" placeholder="Enter folder name" style="width: 100%; margin-bottom: 20px;">

                <label style="font-weight: 600; display: block; margin-bottom: 8px;">Icon</label>
                <div class="folder-icon-grid">
                    <div class="folder-icon-option selected" data-icon="fa-folder"><i class="fas fa-folder"></i></div>
                    <div class="folder-icon-option" data-icon="fa-shirt"><i class="fas fa-shirt"></i></div>
                    <div class="folder-icon-option" data-icon="fa-mug-hot"><i class="fas fa-mug-hot"></i></div>
                    <div class="folder-icon-option" data-icon="fa-bag-shopping"><i class="fas fa-bag-shopping"></i></div>
                    <div class="folder-icon-option" data-icon="fa-book"><i class="fas fa-book"></i></div>
                    <div class="folder-icon-option" data-icon="fa-star"><i class="fas fa-star"></i></div>
                </div>

                <label style="font-weight: 600; display: block; margin-bottom: 8px;">Color</label>
                <div class="folder-color-grid">
                    <div class="folder-color-option selected" data-color="#667eea" style="background: #667eea;"></div>
                    <div class="folder-color-option" data-color="#f43f5e" style="background: #f43f5e;"></div>
                    <div class="folder-color-option" data-color="#10b981" style="background: #10b981;"></div>
                    <div class="folder-color-option" data-color="#f59e0b" style="background: #f59e0b;"></div>
                    <div class="folder-color-option" data-color="#8b5cf6" style="background: #8b5cf6;"></div>
                    <div class="folder-color-option" data-color="#06b6d4" style="background: #06b6d4;"></div>
                </div>

                <button class="btn btn-primary" id="createFolderBtn" style="width: 100%; margin-top: 20px;">
                    <i class="fas fa-check"></i>
                    Create Folder
                </button>
            </div>
        </div>
    </div>

    <!-- PROGRESS MODAL -->
    <div class="modal" id="progressModal">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-header">
                <h3><i class="fas fa-rocket"></i> Generating</h3>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <p style="text-align: center; color: var(--gray);" id="progressText">Preparing...</p>
        </div>
    </div>

    <!-- STORAGE MODAL -->
    <div class="modal" id="storageModal">
        <div class="modal-content" style="max-width: 520px;">
            <div class="modal-header">
                <h3><i class="fas fa-database"></i> Storage Info</h3>
                <button class="close-modal" onclick="closeStorageModal()">×</button>
            </div>
            <div style="background: #d1fae5; padding: 16px; border-radius: 8px;">
                <strong><i class="fas fa-check-circle"></i> IndexedDB Storage</strong>
                <ul style="margin-left: 20px; margin-top: 8px;">
                    <li><strong>500MB+ capacity</strong></li>
                    <li>High-resolution images</li>
                    <li>Browser-based storage</li>
                </ul>
            </div>
        </div>
    </div>

    <input type="file" id="designPngsInput" multiple accept=".png,image/png" style="display: none;">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // ========================================
        // LIBRARY & WATERMARK CONFIGURATION
        // ========================================
        // EASY TO EXTEND: Just add more categories or mockups here!
        const LIBRARY_CONFIG = {
            baseUrl: 'https://raw.githubusercontent.com/awrdj/t00ls/main/mockupsGen/mckps',
            categories: {
                kids_mockups: {
                    name: 'Kids',
                    icon: 'fa-child',
                    mockups: ['Kids1.jpg', 'Kids2.jpg']
                },
                family_mockups: {
                    name: 'Family',
                    icon: 'fa-people-group',
                    mockups: ['Family1.jpg', 'Family2.jpg', 'Family3.jpg']
                },
                flat_mockups: {
                    name: 'Flat Lay',
                    icon: 'fa-layer-group',
                    mockups: ['Flat1.jpg', 'Flat2.jpg']
                },
                men_mockups: {
                    name: 'Men',
                    icon: 'fa-person',
                    mockups: ['Men1.jpg', 'Men2.jpg']
                },
                women_mockups: {
                    name: 'Women',
                    icon: 'fa-person-dress',
                    mockups: ['Women1.jpg', 'Women2.jpg']
                }
            },
            watermarks: {
                baseUrl: 'https://raw.githubusercontent.com/awrdj/t00ls/main/mockupsGen/mckps/wtrmrks',
                files: ['Watermark1.png', 'Watermark2.png', 'Watermark3.png']
            }
        };

        // ========================================
        // DATABASE SETUP
        // ========================================
        const DB_NAME = 'TierPodDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'mockups';
        let db;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        objectStore.createIndex('name', 'name', { unique: false });
                    }
                };
            });
        }

        function saveMockupToDB(mockup) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.put(mockup);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function getAllMockupsFromDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function deleteMockupFromDB(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function clearAllDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const objectStore = transaction.objectStore(STORE_NAME);
                const request = objectStore.clear();
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function getDBSize() {
            try {
                const mockups = await getAllMockupsFromDB();
                let totalSize = 0;
                for (const mockup of mockups) {
                    if (mockup.dataUrl) {
                        const base64Data = mockup.dataUrl.split(',')[1] || mockup.dataUrl;
                        totalSize += base64Data.length * 0.75;
                    }
                }
                return totalSize;
            } catch (error) {
                console.error('Storage calculation error:', error);
                return 0;
            }
        }

        // ========================================
        // STATE MANAGEMENT
        // ========================================
        const state = {
            mockups: [],
            currentMockup: null,
            designElements: [],
            activeElement: null,
            savedMockupData: {},
            currentAspectRatio: 'free',
            mockupEnabled: {},
            folders: [],
            currentFolderId: 'all',
            mockupToFolder: {},
            selectedWatermark: null,
            watermarkImages: {}
        };

        let elementIdCounter = 0;

        // ========================================
        // WATERMARK SYSTEM
        // ========================================
        async function loadWatermarks() {
            const grid = document.getElementById('watermarkGrid');

            // Add "None" option
            const noneOption = document.createElement('div');
            noneOption.className = 'watermark-option none selected';
            noneOption.innerHTML = '<i class="fas fa-ban"></i><div style="font-size: 0.7em; margin-top: 4px;">None</div>';
            noneOption.onclick = () => selectWatermark(null, noneOption);
            grid.appendChild(noneOption);

            // Load watermarks from GitHub
            for (let i = 0; i < LIBRARY_CONFIG.watermarks.files.length; i++) {
                const filename = LIBRARY_CONFIG.watermarks.files[i];
                const url = `${LIBRARY_CONFIG.watermarks.baseUrl}/${filename}`;

                const option = document.createElement('div');
                option.className = 'watermark-option';
                option.dataset.watermarkId = `watermark_${i}`;

                const img = document.createElement('img');
                img.src = url;
                img.alt = `Watermark ${i + 1}`;
                img.onerror = () => {
                    option.innerHTML = '<i class="fas fa-image-slash"></i>';
                };

                option.appendChild(img);
                option.onclick = () => selectWatermark(url, option);

                grid.appendChild(option);

                // Preload watermark image
                try {
                    const watermarkImg = await loadImage(url);
                    state.watermarkImages[url] = watermarkImg;
                } catch (e) {
                    console.warn('Failed to load watermark:', url);
                }
            }
        }

        function selectWatermark(url, optionElement) {
            document.querySelectorAll('.watermark-option').forEach(el => el.classList.remove('selected'));
            optionElement.classList.add('selected');
            state.selectedWatermark = url;

            console.log('Watermark selected:', url || 'None');
        }

        // ========================================
        // LIBRARY SYSTEM
        // ========================================
        function openLibraryModal() {
            const modal = document.getElementById('libraryModal');
            modal.classList.add('active');

            renderLibraryCategories();

            // Select first category by default
            const firstCategory = Object.keys(LIBRARY_CONFIG.categories)[0];
            if (firstCategory) {
                loadLibraryCategory(firstCategory);
            }
        }

        function renderLibraryCategories() {
            const container = document.getElementById('libraryCategories');
            container.innerHTML = '';

            for (const [categoryId, category] of Object.entries(LIBRARY_CONFIG.categories)) {
                const btn = document.createElement('div');
                btn.className = 'category-btn';
                btn.innerHTML = `
                    <i class="fas ${category.icon}"></i>
                    <div>${category.name}</div>
                    <small style="color: var(--gray); font-size: 0.8em;">${category.mockups.length} mockups</small>
                `;
                btn.onclick = () => loadLibraryCategory(categoryId);
                container.appendChild(btn);
            }
        }

        async function loadLibraryCategory(categoryId) {
            // Update active state
            document.querySelectorAll('.category-btn').forEach((btn, idx) => {
                btn.classList.toggle('active', Object.keys(LIBRARY_CONFIG.categories)[idx] === categoryId);
            });

            const category = LIBRARY_CONFIG.categories[categoryId];
            const container = document.getElementById('libraryMockups');
            const loadingState = document.getElementById('libraryLoadingState');

            // Show loading
            container.style.display = 'none';
            loadingState.style.display = 'block';

            container.innerHTML = '';

            for (const mockupFile of category.mockups) {
                const url = `${LIBRARY_CONFIG.baseUrl}/${categoryId}/${mockupFile}`;

                const item = document.createElement('div');
                item.className = 'library-mockup-item';

                const img = document.createElement('img');
                img.className = 'library-mockup-img';
                img.src = url;
                img.alt = mockupFile;
                img.onerror = () => {
                    img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="200" height="200"%3E%3Crect fill="%23f3f4f6" width="200" height="200"/%3E%3Ctext x="50%25" y="50%25" text-anchor="middle" dy=".3em" fill="%236b7280"%3ENo Image%3C/text%3E%3C/svg%3E';
                };

                const name = document.createElement('div');
                name.className = 'library-mockup-name';
                name.textContent = mockupFile.replace('.jpg', '').replace('.png', '');

                item.appendChild(img);
                item.appendChild(name);

                item.onclick = () => selectLibraryMockup(url, mockupFile);

                container.appendChild(item);
            }

            // Hide loading
            await new Promise(resolve => setTimeout(resolve, 300));
            loadingState.style.display = 'none';
            container.style.display = 'grid';
        }

        async function selectLibraryMockup(url, filename) {
            try {
                // Show loading indicator
                const progressModal = document.getElementById('progressModal');
                const progressText = document.getElementById('progressText');
                progressModal.classList.add('active');
                progressText.textContent = 'Loading mockup from library...';

                // Fetch the image
                const response = await fetch(url);
                const blob = await response.blob();

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const img = new Image();
                    img.onload = async () => {
                        const mockup = {
                            id: 'mockup_' + Date.now() + '_' + Math.random(),
                            name: filename,
                            dataUrl: e.target.result,
                            originalWidth: img.width,
                            originalHeight: img.height,
                            fromLibrary: true
                        };

                        await saveMockupToDB(mockup);
                        state.mockups.push(mockup);
                        state.mockupEnabled[mockup.id] = true;

                        if (state.currentFolderId !== 'all') {
                            state.mockupToFolder[mockup.id] = state.currentFolderId;
                            saveFoldersToDB();
                        }

                        renderFolderList();
                        renderMockupList();
                        updateStats();
                        updateGenerateButton();
                        await updateStorageMeter();

                        // Close modals
                        progressModal.classList.remove('active');
                        document.getElementById('libraryModal').classList.remove('active');

                        alert('✅ Mockup added from library!');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(blob);

            } catch (error) {
                console.error('Library load error:', error);
                alert('⚠️ Failed to load mockup from library. Check console for details.');
                document.getElementById('progressModal').classList.remove('active');
            }
        }

        // ========================================
        // FOLDER SYSTEM
        // ========================================
        function saveFoldersToDB() {
            try {
                localStorage.setItem('tierpod_folders', JSON.stringify(state.folders));
                localStorage.setItem('tierpod_mockup_folders', JSON.stringify(state.mockupToFolder));
                localStorage.setItem('tierpod_current_folder', state.currentFolderId);
            } catch (e) {
                console.error('Error saving folders:', e);
            }
        }

        function loadFoldersFromDB() {
            try {
                const savedFolders = localStorage.getItem('tierpod_folders');
                const savedMockupFolders = localStorage.getItem('tierpod_mockup_folders');
                const savedCurrentFolder = localStorage.getItem('tierpod_current_folder');

                if (savedFolders) {
                    state.folders = JSON.parse(savedFolders);
                } else {
                    state.folders = [
                        { id: 'all', name: 'All Mockups', icon: 'fa-images', color: '#667eea' }
                    ];
                }

                if (savedMockupFolders) {
                    state.mockupToFolder = JSON.parse(savedMockupFolders);
                }

                if (savedCurrentFolder) {
                    state.currentFolderId = savedCurrentFolder;
                }
            } catch (e) {
                console.error('Error loading folders:', e);
                state.folders = [
                    { id: 'all', name: 'All Mockups', icon: 'fa-images', color: '#667eea' }
                ];
            }
        }

        function createFolder(name, icon = 'fa-folder', color = '#667eea') {
            const folderId = 'folder_' + Date.now();
            const newFolder = {
                id: folderId,
                name: name,
                icon: icon,
                color: color
            };
            state.folders.push(newFolder);
            saveFoldersToDB();
            renderFolderList();
            return folderId;
        }

        function deleteFolder(folderId) {
            if (folderId === 'all') {
                alert('Cannot delete "All Mockups" folder');
                return;
            }

            if (!confirm('Delete this folder? Templates will move to "All Mockups".')) {
                return;
            }

            for (const mockupId in state.mockupToFolder) {
                if (state.mockupToFolder[mockupId] === folderId) {
                    delete state.mockupToFolder[mockupId];
                }
            }

            state.folders = state.folders.filter(f => f.id !== folderId);

            if (state.currentFolderId === folderId) {
                state.currentFolderId = 'all';
            }

            saveFoldersToDB();
            renderFolderList();
            renderMockupList();
            updateCurrentFolderBadge();
        }

        function assignMockupToFolder(mockupId, folderId) {
            if (folderId === 'all') {
                delete state.mockupToFolder[mockupId];
            } else {
                state.mockupToFolder[mockupId] = folderId;
            }
            saveFoldersToDB();
            renderMockupList();
            renderFolderList();
        }

        function getMockupsInFolder(folderId) {
            if (folderId === 'all') {
                return state.mockups;
            }
            return state.mockups.filter(m => state.mockupToFolder[m.id] === folderId);
        }

        function getMockupCount(folderId) {
            return getMockupsInFolder(folderId).length;
        }

        function switchFolder(folderId) {
            state.currentFolderId = folderId;
            saveFoldersToDB();
            renderFolderList();
            renderMockupList();
            updateCurrentFolderBadge();
            updateGenerateButton();
        }

        function updateCurrentFolderBadge() {
            const badge = document.getElementById('currentFolderBadge');
            const folder = state.folders.find(f => f.id === state.currentFolderId);
            if (badge && folder) {
                badge.textContent = folder.name;
                badge.style.display = 'inline-block';
            }
        }

        function renderFolderList() {
            const folderList = document.getElementById('folderList');
            if (!folderList) return;

            folderList.innerHTML = '';

            for (const folder of state.folders) {
                const count = getMockupCount(folder.id);
                const li = document.createElement('li');
                li.className = 'folder-item';
                if (folder.id === state.currentFolderId) {
                    li.classList.add('active');
                }

                const deleteBtn = folder.id !== 'all' ? 
                    `<button class="folder-delete-btn" onclick="event.stopPropagation(); deleteFolder('${folder.id}')"><i class="fas fa-trash"></i></button>` : '';

                li.innerHTML = `
                    <i class="fas ${folder.icon} folder-icon" style="color: ${folder.id === state.currentFolderId ? 'white' : folder.color};"></i>
                    <span class="folder-name">${folder.name}</span>
                    <span class="folder-count">${count}</span>
                    ${deleteBtn}
                `;

                li.onclick = () => switchFolder(folder.id);
                folderList.appendChild(li);
            }
        }

        // Folder Modal Functions
        let selectedFolderIcon = 'fa-folder';
        let selectedFolderColor = '#667eea';

        function openFolderModal() {
            const modal = document.getElementById('folderModal');
            const input = document.getElementById('folderNameInput');

            if (modal && input) {
                modal.classList.add('active');
                input.value = '';
                input.focus();

                selectedFolderIcon = 'fa-folder';
                selectedFolderColor = '#667eea';

                document.querySelectorAll('.folder-icon-option').forEach(el => {
                    el.classList.toggle('selected', el.dataset.icon === 'fa-folder');
                });

                document.querySelectorAll('.folder-color-option').forEach(el => {
                    el.classList.toggle('selected', el.dataset.color === '#667eea');
                });
            }
        }

        // ========================================
        // INITIALIZATION
        // ========================================
        window.addEventListener('load', async () => {
            try {
                await initDB();
                await loadMockupsFromDB();
                loadFoldersFromDB();
                await loadWatermarks();
                await updateStorageMeter();
                renderFolderList();
                renderMockupList();
                updateStats();
                updateCurrentFolderBadge();
                updateGenerateButton();

                // Setup event listeners
                setupEventListeners();
            } catch (error) {
                console.error('Init error:', error);
                alert('⚠️ Database initialization failed');
            }
        });

        function setupEventListeners() {
            // Upload buttons
            document.getElementById('uploadDesktopBtn')?.addEventListener('click', () => {
                document.getElementById('mockupFilesInput').click();
            });

            document.getElementById('browseLibraryBtn')?.addEventListener('click', openLibraryModal);

            document.getElementById('closeLibraryModal')?.addEventListener('click', () => {
                document.getElementById('libraryModal').classList.remove('active');
            });

            // Folder modal
            document.getElementById('addFolderBtnInline')?.addEventListener('click', openFolderModal);

            document.getElementById('cancelFolderBtn')?.addEventListener('click', () => {
                document.getElementById('folderModal')?.classList.remove('active');
            });

            document.getElementById('createFolderBtn')?.addEventListener('click', () => {
                const input = document.getElementById('folderNameInput');
                const name = input?.value.trim();

                if (!name) {
                    alert('Please enter a folder name');
                    return;
                }

                const folderId = createFolder(name, selectedFolderIcon, selectedFolderColor);
                document.getElementById('folderModal')?.classList.remove('active');
                switchFolder(folderId);
            });

            document.querySelectorAll('.folder-icon-option').forEach(el => {
                el.addEventListener('click', () => {
                    document.querySelectorAll('.folder-icon-option').forEach(e => e.classList.remove('selected'));
                    el.classList.add('selected');
                    selectedFolderIcon = el.dataset.icon;
                });
            });

            document.querySelectorAll('.folder-color-option').forEach(el => {
                el.addEventListener('click', () => {
                    document.querySelectorAll('.folder-color-option').forEach(e => e.classList.remove('selected'));
                    el.classList.add('selected');
                    selectedFolderColor = el.dataset.color;
                });
            });

            document.getElementById('folderNameInput')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('createFolderBtn')?.click();
                }
            });

            // Collapsible sections
            document.getElementById('foldersToggle')?.addEventListener('click', function() {
                toggleSection(this, 'foldersContent');
            });

            document.getElementById('watermarksToggle')?.addEventListener('click', function() {
                toggleSection(this, 'watermarksContent');
            });

            // Modal close on backdrop
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
        }

        function toggleSection(header, contentId) {
            const content = document.getElementById(contentId);
            if (content) {
                header.classList.toggle('collapsed');
                content.classList.toggle('collapsed');
            }
        }

        async function loadMockupsFromDB() {
            try {
                state.mockups = await getAllMockupsFromDB();
                const savedData = localStorage.getItem('tierpod_positions');
                if (savedData) {
                    state.savedMockupData = JSON.parse(savedData);
                }
                const enabledData = localStorage.getItem('tierpod_enabled');
                if (enabledData) {
                    state.mockupEnabled = JSON.parse(enabledData);
                } else {
                    state.mockups.forEach(m => {
                        if (state.mockupEnabled[m.id] === undefined) {
                            state.mockupEnabled[m.id] = true;
                        }
                    });
                }
            } catch (error) {
                console.error('Load error:', error);
            }
        }

        async function updateStorageMeter() {
            try {
                const size = await getDBSize();
                const sizeMB = (size / (1024 * 1024)).toFixed(2);
                const limit = 500 * 1024 * 1024;
                const percent = Math.min((size / limit) * 100, 100);

                document.getElementById('storageSize').textContent = sizeMB + ' MB';
                document.getElementById('storagePercent').textContent = percent.toFixed(0) + '%';
                document.getElementById('storageFill').style.width = percent + '%';

                if (percent > 80) {
                    document.getElementById('storageFill').classList.add('warning');
                } else {
                    document.getElementById('storageFill').classList.remove('warning');
                }
            } catch (error) {
                console.error('Storage meter error:', error);
            }
        }

        function updateStats() {
            document.getElementById('mockupCount').textContent = state.mockups.length;
        }

        function savePositionsToStorage() {
            try {
                localStorage.setItem('tierpod_positions', JSON.stringify(state.savedMockupData));
            } catch (e) {
                console.error('Position save error:', e);
            }
        }

        // ========================================
        // MOCKUP MANAGEMENT
        // ========================================
        function toggleMockup(mockupId) {
            const currentState = state.mockupEnabled[mockupId];
            const newState = (currentState === false) ? true : false;
            state.mockupEnabled[mockupId] = newState;

            localStorage.setItem('tierpod_enabled', JSON.stringify(state.mockupEnabled));

            renderMockupList();
            updateGenerateButton();
        }

        async function deleteMockup(mockupId) {
            if (!confirm('🗑️ Delete this template? This cannot be undone.')) {
                return;
            }

            try {
                await deleteMockupFromDB(mockupId);
                state.mockups = state.mockups.filter(m => m.id !== mockupId);
                delete state.savedMockupData[mockupId];
                delete state.mockupToFolder[mockupId];
                savePositionsToStorage();
                saveFoldersToDB();

                if (state.currentMockup && state.currentMockup.id === mockupId) {
                    state.currentMockup = null;
                    document.getElementById('mockupPreview').classList.remove('visible');
                    document.querySelector('.preview-placeholder').style.display = 'block';
                    clearDesignElements();
                    document.getElementById('addPngBtn').disabled = true;
                }

                renderFolderList();
                renderMockupList();
                updateStats();
                updateGenerateButton();
                await updateStorageMeter();

            } catch (error) {
                console.error('Delete error:', error);
                alert('⚠️ Error deleting template');
            }
        }

        async function clearStorage() {
            if (confirm('⚠️ Clear all templates and positions?')) {
                try {
                    await clearAllDB();
                    localStorage.clear();
                    state.mockups = [];
                    state.savedMockupData = {};
                    state.mockupEnabled = {};
                    state.currentMockup = null;
                    state.folders = [{ id: 'all', name: 'All Mockups', icon: 'fa-images', color: '#667eea' }];
                    state.mockupToFolder = {};
                    state.currentFolderId = 'all';
                    state.selectedWatermark = null;
                    clearDesignElements();
                    renderFolderList();
                    renderMockupList();
                    updateStats();
                    updateCurrentFolderBadge();
                    updateGenerateButton();
                    await updateStorageMeter();
                    await loadWatermarks();
                    alert('✅ All data cleared!');
                } catch (error) {
                    console.error('Clear error:', error);
                    alert('⚠️ Error clearing data');
                }
            }
        }

        function showStorageInfo() {
            document.getElementById('storageModal').classList.add('active');
        }

        function closeStorageModal() {
            document.getElementById('storageModal').classList.remove('active');
        }

        // Folder context menu
        let contextMenuMockupId = null;

        function showMockupFolderMenu(mockupId, event) {
            event.stopPropagation();

            document.querySelectorAll('.folder-context-menu').forEach(el => el.remove());

            contextMenuMockupId = mockupId;

            const menu = document.createElement('div');
            menu.className = 'folder-context-menu';
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';

            for (const folder of state.folders) {
                const item = document.createElement('div');
                item.className = 'folder-context-menu-item';
                item.innerHTML = `
                    <i class="fas ${folder.icon}" style="color: ${folder.color};"></i>
                    <span>${folder.name}</span>
                `;
                item.onclick = () => {
                    assignMockupToFolder(mockupId, folder.id);
                    menu.remove();
                };
                menu.appendChild(item);
            }

            document.body.appendChild(menu);

            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                });
            }, 100);
        }

        // ========================================
        // FILE UPLOAD
        // ========================================
        const mockupInput = document.getElementById('mockupFilesInput');

        mockupInput.addEventListener('change', (e) => {
            handleMockupFiles(e.target.files);
        });

        async function handleMockupFiles(files) {
            for (const file of Array.from(files)) {
                try {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        const img = new Image();
                        img.onload = async () => {
                            const mockup = {
                                id: 'mockup_' + Date.now() + '_' + Math.random(),
                                name: file.name,
                                dataUrl: e.target.result,
                                originalWidth: img.width,
                                originalHeight: img.height,
                                fromLibrary: false
                            };

                            await saveMockupToDB(mockup);
                            state.mockups.push(mockup);
                            state.mockupEnabled[mockup.id] = true;

                            if (state.currentFolderId !== 'all') {
                                state.mockupToFolder[mockup.id] = state.currentFolderId;
                                saveFoldersToDB();
                            }

                            renderFolderList();
                            renderMockupList();
                            updateStats();
                            updateGenerateButton();
                            await updateStorageMeter();
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('⚠️ Error uploading file');
                }
            }
        }

        function renderMockupList() {
            const mockupList = document.getElementById('mockupList');

            const mockupsToShow = getMockupsInFolder(state.currentFolderId);

            if (mockupsToShow.length === 0) {
                mockupList.innerHTML = `
                    <li class="empty-state" style="padding: 30px 16px;">
                        <i class="fas fa-image"></i>
                        <p>No templates in this folder</p>
                    </li>
                `;
                return;
            }

            mockupList.innerHTML = mockupsToShow.map(m => {
                const saved = state.savedMockupData[m.id];
                const elementCount = saved ? saved.elements.length : 0;
                const isEnabled = state.mockupEnabled[m.id] !== false;
                const libraryBadge = m.fromLibrary ? '<span class="library-badge">LIB</span>' : '';
                return `
                    <li class="mockup-item ${state.currentMockup?.id === m.id ? 'selected' : ''} ${!isEnabled ? 'disabled' : ''}" 
                        data-id="${m.id}">
                        <div class="mockup-name">
                            <i class="fas fa-image"></i>
                            <span>${m.name}</span>
                            ${libraryBadge}
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            ${elementCount > 0 ? `<div class="mockup-badge"><i class="fas fa-check"></i> ${elementCount}</div>` : ''}
                            <button class="mockup-folder-btn" onclick="event.stopPropagation(); showMockupFolderMenu('${m.id}', event)" title="Move to folder">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="mockup-toggle ${isEnabled ? 'enabled' : ''}" onclick="event.stopPropagation(); toggleMockup('${m.id}')" title="${isEnabled ? 'Enabled' : 'Disabled'}">
                                <div class="mockup-toggle-slider"></div>
                            </div>
                            <button class="delete-mockup-btn" onclick="event.stopPropagation(); deleteMockup('${m.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </li>
                `;
            }).join('');

            document.querySelectorAll('.mockup-item').forEach(item => {
                item.addEventListener('click', () => selectMockup(item.dataset.id));
            });
        }

        function selectMockup(id) {
            if (state.currentMockup && state.designElements.length > 0) {
                saveCurrentMockupElements();
            }

            state.currentMockup = state.mockups.find(m => m.id === id);

            const mockupPreview = document.getElementById('mockupPreview');
            mockupPreview.src = state.currentMockup.dataUrl;
            mockupPreview.classList.add('visible');
            document.querySelector('.preview-placeholder').style.display = 'none';

            clearDesignElements();

            if (state.savedMockupData[id]) {
                const savedData = state.savedMockupData[id];
                mockupPreview.onload = () => {
                    savedData.elements.forEach(elementData => {
                        createDesignElement(elementData);
                    });
                };
            }

            document.getElementById('addPngBtn').disabled = false;
            document.getElementById('opacitySlider').disabled = false;

            renderMockupList();
            updateGenerateButton();
        }

        // ========================================
        // DESIGN ELEMENTS
        // ========================================
        document.getElementById('addPngBtn').addEventListener('click', () => {
            if (!state.currentMockup) return;

            const mockupPreview = document.getElementById('mockupPreview');
            const previewContainer = document.getElementById('previewContainer');
            const mockupRect = mockupPreview.getBoundingClientRect();
            const containerRect = previewContainer.getBoundingClientRect();

            let width = 200, height = 200;

            if (state.currentAspectRatio !== 'free') {
                const ratio = state.currentAspectRatio.split(':');
                const w = parseInt(ratio[0]);
                const h = parseInt(ratio[1]);
                width = 200;
                height = (width * h) / w;
            }

            const elementData = {
                id: 'element_' + (++elementIdCounter),
                left: mockupRect.left - containerRect.left + 50,
                top: mockupRect.top - containerRect.top + 50,
                width: width,
                height: height,
                rotation: 0,
                opacity: parseFloat(document.getElementById('opacitySlider').value),
                aspectRatio: state.currentAspectRatio
            };

            createDesignElement(elementData);
            document.getElementById('savePositionBtn').disabled = false;
        });

        function createDesignElement(data) {
            const wrapper = document.createElement('div');
            wrapper.className = 'design-wrapper';
            wrapper.dataset.id = data.id;
            wrapper.style.left = data.left + 'px';
            wrapper.style.top = data.top + 'px';
            wrapper.style.width = data.width + 'px';
            wrapper.style.height = data.height + 'px';
            wrapper.style.transform = `rotate(${data.rotation}deg)`;
            wrapper.style.opacity = data.opacity;

            const elementNum = state.designElements.length + 1;
            wrapper.innerHTML = `
                <div class="element-label">Element ${elementNum}</div>
                <div class="design-placeholder">
                    <i class="fas fa-layer-group" style="font-size: 1.8em; margin-bottom: 6px;"></i>
                    <div>Design Area</div>
                    <div style="font-size: 10px; margin-top: 3px;">${Math.round(data.width)} × ${Math.round(data.height)}</div>
                </div>
                <div class="resize-handle"></div>
                <div class="rotate-handle"><i class="fas fa-rotate"></i></div>
                <div class="remove-handle">×</div>
            `;

            document.getElementById('previewContainer').appendChild(wrapper);
            state.designElements.push({ id: data.id, element: wrapper, data: data });

            setupElementInteractions(wrapper, data);

            wrapper.addEventListener('click', (e) => {
                if (!e.target.closest('.remove-handle')) {
                    setActiveElement(wrapper);
                }
            });

            setActiveElement(wrapper);
        }

        function setActiveElement(wrapper) {
            document.querySelectorAll('.design-wrapper').forEach(w => w.classList.remove('active'));
            wrapper.classList.add('active');
            state.activeElement = wrapper;
        }

        function setupElementInteractions(wrapper, data) {
            let isDragging = false, isResizing = false, isRotating = false;
            let startX, startY, initialLeft, initialTop, startWidth, startHeight;
            let centerX, centerY, startAngle, currentRotation = 0;

            wrapper.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('resize-handle') || 
                    e.target.closest('.rotate-handle') ||
                    e.target.closest('.remove-handle')) return;

                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                initialLeft = parseInt(wrapper.style.left);
                initialTop = parseInt(wrapper.style.top);
                setActiveElement(wrapper);
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    wrapper.style.left = (initialLeft + dx) + 'px';
                    wrapper.style.top = (initialTop + dy) + 'px';
                    data.left = parseInt(wrapper.style.left);
                    data.top = parseInt(wrapper.style.top);
                }

                if (isResizing) {
                    const dx = e.clientX - startX;
                    let newWidth = Math.max(50, startWidth + dx);
                    let newHeight = Math.max(50, startHeight + (dx * (startHeight / startWidth)));

                    if (data.aspectRatio !== 'free') {
                        const ratio = data.aspectRatio.split(':');
                        const w = parseInt(ratio[0]);
                        const h = parseInt(ratio[1]);
                        newHeight = (newWidth * h) / w;
                    }

                    wrapper.style.width = newWidth + 'px';
                    wrapper.style.height = newHeight + 'px';
                    data.width = newWidth;
                    data.height = newHeight;
                }

                if (isRotating) {
                    const angle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
                    const rotation = currentRotation + (angle - startAngle) * (180 / Math.PI);
                    wrapper.style.transform = `rotate(${rotation}deg)`;
                    data.rotation = rotation;
                }
            });

            document.addEventListener('mouseup', () => {
                isDragging = isResizing = isRotating = false;
            });

            wrapper.querySelector('.resize-handle').addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startY = e.clientY;
                startWidth = parseInt(wrapper.style.width);
                startHeight = parseInt(wrapper.style.height);
                e.stopPropagation();
                e.preventDefault();
            });

            wrapper.querySelector('.rotate-handle').addEventListener('mousedown', (e) => {
                isRotating = true;
                const rect = wrapper.getBoundingClientRect();
                centerX = rect.left + rect.width / 2;
                centerY = rect.top + rect.height / 2;
                startAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
                const match = wrapper.style.transform.match(/rotate\(([^)]+)deg\)/);
                currentRotation = match ? parseFloat(match[1]) : 0;
                e.stopPropagation();
                e.preventDefault();
            });

            wrapper.querySelector('.remove-handle').addEventListener('click', () => {
                wrapper.remove();
                state.designElements = state.designElements.filter(e => e.id !== data.id);
                if (state.designElements.length === 0) {
                    document.getElementById('savePositionBtn').disabled = true;
                }
                if (state.activeElement === wrapper) {
                    state.activeElement = null;
                }
            });
        }

        document.getElementById('opacitySlider').addEventListener('input', (e) => {
            const opacity = parseFloat(e.target.value);
            document.getElementById('opacityValue').textContent = Math.round(opacity * 100) + '%';

            if (state.activeElement) {
                state.activeElement.style.opacity = opacity;
                const elementData = state.designElements.find(el => el.element === state.activeElement);
                if (elementData) elementData.data.opacity = opacity;
            }
        });

        // Aspect Ratio Controls
        document.querySelectorAll('.aspect-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.aspect-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.currentAspectRatio = btn.dataset.ratio;
                document.getElementById('customRatioInput').classList.toggle('active', btn.dataset.ratio === 'custom');

                if (state.activeElement) {
                    const elementData = state.designElements.find(el => el.element === state.activeElement);
                    if (elementData) {
                        applyAspectRatioToElement(elementData, btn.dataset.ratio);
                    }
                }
            });
        });

        function applyAspectRatioToElement(elementData, ratio) {
            elementData.data.aspectRatio = ratio;

            if (ratio !== 'free') {
                const ratioSplit = ratio.split(':');
                const w = parseInt(ratioSplit[0]);
                const h = parseInt(ratioSplit[1]);
                const currentWidth = elementData.data.width;
                const newHeight = (currentWidth * h) / w;

                state.activeElement.style.height = newHeight + 'px';
                elementData.data.height = newHeight;
            }
        }

        function applyCustomRatio() {
            const w = parseInt(document.getElementById('ratioWidth').value) || 1;
            const h = parseInt(document.getElementById('ratioHeight').value) || 1;
            state.currentAspectRatio = `${w}:${h}`;

            if (state.activeElement) {
                const elementData = state.designElements.find(el => el.element === state.activeElement);
                if (elementData) {
                    applyAspectRatioToElement(elementData, `${w}:${h}`);
                }
                alert(`✅ Custom ratio applied: ${w}:${h}`);
            }
        }

        document.getElementById('savePositionBtn').addEventListener('click', () => {
            if (!state.currentMockup || state.designElements.length === 0) return;

            saveCurrentMockupElements();
            savePositionsToStorage();

            renderMockupList();
            updateGenerateButton();

            alert('✅ Saved!');
        });

        function saveCurrentMockupElements() {
            if (!state.currentMockup) return;

            const mockupPreview = document.getElementById('mockupPreview');
            const previewContainer = document.getElementById('previewContainer');
            const mockupRect = mockupPreview.getBoundingClientRect();
            const containerRect = previewContainer.getBoundingClientRect();

            state.savedMockupData[state.currentMockup.id] = {
                elements: state.designElements.map(el => ({...el.data})),
                previewBounds: {
                    width: mockupRect.width,
                    height: mockupRect.height,
                    left: mockupRect.left - containerRect.left,
                    top: mockupRect.top - containerRect.top
                }
            };
        }

        function clearDesignElements() {
            document.querySelectorAll('.design-wrapper').forEach(el => el.remove());
            state.designElements = [];
            state.activeElement = null;
        }

        function updateGenerateButton() {
            const mockupsInCurrentFolder = getMockupsInFolder(state.currentFolderId);
            const enabledInFolder = mockupsInCurrentFolder.filter(m => 
                state.mockupEnabled[m.id] !== false && state.savedMockupData[m.id]
            );

            const hasData = enabledInFolder.length > 0;
            document.getElementById('loadExportBtn').disabled = !hasData;

            const btn = document.getElementById('loadExportBtn');
            if (hasData) {
                const count = enabledInFolder.length;
                btn.innerHTML = `<i class="fas fa-rocket"></i><span>Generate ${count} Template${count > 1 ? 's' : ''}</span>`;
            } else {
                btn.innerHTML = '<i class="fas fa-rocket"></i><span>Generate & Download</span>';
            }
        }

        // ========================================
        // EXPORT / GENERATION (WITH WATERMARKS)
        // ========================================
        document.getElementById('loadExportBtn').addEventListener('click', () => {
            document.getElementById('designPngsInput').click();
        });

        document.getElementById('designPngsInput').addEventListener('change', async (e) => {
            const pngFiles = Array.from(e.target.files);
            if (pngFiles.length === 0) return;

            const progressModal = document.getElementById('progressModal');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            progressModal.classList.add('active');

            // Filter by current folder and enabled state
            const mockupsInCurrentFolder = getMockupsInFolder(state.currentFolderId);
            const mockupsWithData = mockupsInCurrentFolder
                .filter(m => state.mockupEnabled[m.id] !== false && state.savedMockupData[m.id])
                .map(m => m.id);

            console.log('=== EXPORT DEBUG ===');
            console.log('Current Folder:', state.currentFolderId);
            console.log('Will export:', mockupsWithData.length, 'mockups');
            console.log('Watermark:', state.selectedWatermark || 'None');

            if (mockupsWithData.length === 0) {
                progressModal.classList.remove('active');
                alert('⚠️ No enabled templates with saved elements in this folder!');
                return;
            }

            const total = pngFiles.length * mockupsWithData.length;
            let completed = 0;

            const zip = new JSZip();

            for (const pngFile of pngFiles) {
                const pngDataUrl = await readFileAsDataURL(pngFile);
                const pngImg = await loadImage(pngDataUrl);

                for (const mockupId of mockupsWithData) {
                    const mockup = state.mockups.find(m => m.id === mockupId);
                    const savedData = state.savedMockupData[mockupId];

                    const mockupImg = await loadImage(mockup.dataUrl);

                    // Create canvas
                    const canvas = document.createElement('canvas');
                    canvas.width = mockup.originalWidth;
                    canvas.height = mockup.originalHeight;

                    const mockupExtension = mockup.name.toLowerCase();
                    const isPNG = mockupExtension.endsWith('.png');

                    const ctx = canvas.getContext('2d', { 
                        alpha: isPNG,
                        willReadFrequently: false 
                    });

                    // Draw mockup background
                    ctx.drawImage(mockupImg, 0, 0, mockup.originalWidth, mockup.originalHeight);

                    // Calculate scale factors
                    const scaleX = mockup.originalWidth / savedData.previewBounds.width;
                    const scaleY = mockup.originalHeight / savedData.previewBounds.height;

                    // Overlay design elements
                    for (const element of savedData.elements) {
                        ctx.save();

                        const scaledLeft = (element.left - savedData.previewBounds.left) * scaleX;
                        const scaledTop = (element.top - savedData.previewBounds.top) * scaleY;
                        const scaledWidth = element.width * scaleX;
                        const scaledHeight = element.height * scaleY;

                        ctx.globalAlpha = element.opacity;
                        ctx.translate(scaledLeft + scaledWidth/2, scaledTop + scaledHeight/2);
                        ctx.rotate(element.rotation * Math.PI / 180);

                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';

                        ctx.drawImage(pngImg, -scaledWidth/2, -scaledHeight/2, scaledWidth, scaledHeight);

                        ctx.restore();
                    }

                    // Add watermark if selected
                    if (state.selectedWatermark && state.watermarkImages[state.selectedWatermark]) {
                        const watermarkImg = state.watermarkImages[state.selectedWatermark];

                        // Position watermark at bottom-right corner
                        const watermarkMaxWidth = mockup.originalWidth * 0.25; // 25% of image width
                        const watermarkScale = Math.min(1, watermarkMaxWidth / watermarkImg.width);
                        const watermarkWidth = watermarkImg.width * watermarkScale;
                        const watermarkHeight = watermarkImg.height * watermarkScale;

                        const watermarkX = mockup.originalWidth - watermarkWidth - 20;
                        const watermarkY = mockup.originalHeight - watermarkHeight - 20;

                        ctx.save();
                        ctx.globalAlpha = 0.8; // Slight transparency
                        ctx.drawImage(watermarkImg, watermarkX, watermarkY, watermarkWidth, watermarkHeight);
                        ctx.restore();
                    }

                    // Export
                    const baseName = pngFile.name.replace(/\.(png|jpg|jpeg)$/i, '');
                    let dataUrl, finalFileName;

                    if (isPNG) {
                        dataUrl = canvas.toDataURL('image/png');
                        finalFileName = `${baseName}_${mockup.name}`;
                    } else {
                        dataUrl = canvas.toDataURL('image/jpeg', 1.0);
                        const mockupBaseName = mockup.name.replace(/\.(png|jpg|jpeg)$/i, '');
                        finalFileName = `${baseName}_${mockupBaseName}.jpg`;
                    }

                    const base64 = dataUrl.split(',')[1];
                    zip.file(finalFileName, base64, { base64: true });

                    completed++;
                    const progress = Math.round((completed / total) * 100);
                    progressFill.style.width = progress + '%';
                    progressFill.textContent = progress + '%';
                    progressText.textContent = `Generated ${completed} of ${total}...`;

                    await new Promise(resolve => setTimeout(resolve, 50));
                }
            }

            if (total === 1) {
                progressText.textContent = 'Downloading image...';

                const firstFile = zip.file(Object.keys(zip.files)[0]);
                const base64Data = await firstFile.async('base64');

                const link = document.createElement('a');
                link.download = Object.keys(zip.files)[0];
                link.href = 'data:image/png;base64,' + base64Data;
                link.click();

                setTimeout(() => {
                    progressModal.classList.remove('active');
                    const folderName = state.folders.find(f => f.id === state.currentFolderId)?.name || 'mockups';
                    alert(`✅ Generated 1 mockup from "${folderName}"!\n\n📥 Downloaded as PNG file.`);
                    document.getElementById('designPngsInput').value = '';
                }, 500);

            } else {
                progressText.textContent = 'Creating ZIP...';
                const blob = await zip.generateAsync({ type: 'blob' });
                const link = document.createElement('a');
                const folderName = state.folders.find(f => f.id === state.currentFolderId)?.name || 'mockups';
                link.download = `${folderName.replace(/\s+/g, '_')}_${Date.now()}.zip`;
                link.href = URL.createObjectURL(blob);
                link.click();

                setTimeout(() => {
                    progressModal.classList.remove('active');
                    alert(`✅ Generated ${total} mockups from "${folderName}"!\n\n📦 Downloaded as ZIP file.`);
                    document.getElementById('designPngsInput').value = '';
                }, 500);
            }
        });

        function readFileAsDataURL(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
        }

        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error('Failed to load image: ' + src));
                img.crossOrigin = 'anonymous';
                img.src = src;
            });
        }
    </script>
</body>
</html>